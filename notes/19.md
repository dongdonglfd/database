### 1. 崩溃恢复的基本目标

数据库管理系统（DBMS）设计的一个核心任务是保证在系统崩溃后能够恢复数据库的状态，保证事务的 **一致性**、**原子性** 和 **持久性**。这三个属性被合称为 **ACID** 特性：

* **原子性（Atomicity）**：事务中的操作要么全部执行，要么全部不执行。
* **一致性（Consistency）**：事务执行前后的数据库必须保持一致状态。
* **持久性（Durability）**：已提交事务的结果应该在崩溃后永久保存。

当系统崩溃时，数据库的内存中可能保存了部分已提交的、更改过的数据，而这些数据还没有写入到硬盘中。崩溃恢复的目的是保证这些数据在系统恢复后不丢失，并确保数据库的一致性。

### 2. ARIES 恢复算法

ARIES（**Algorithms for Recovery and Isolation Exploiting Semantics**）算法由 IBM 在90年代开发，它解决了崩溃后如何恢复数据库的一系列问题。ARIES 是现代数据库崩溃恢复的基石，主要包括以下三个核心原则：

1. **Write-Ahead Logging (WAL)**：所有的数据库修改操作必须首先记录到日志中，然后才写入数据库。这样即使发生崩溃，日志中的记录仍然可以帮助恢复修改过的数据。

2. **重做历史（Repeating History during Redo）**：恢复过程中，必须重做所有在崩溃前已完成的操作。即使这些操作来自未提交的事务，系统也会在重启时回放这些操作以恢复数据。

3. **撤销变更（Logging Changes During Undo）**：在进行事务回滚（undo）时，ARIES 会将每个撤销操作也记录到日志中，以确保如果系统发生重复崩溃，恢复过程依然能按顺序撤销事务的操作。

### 3. WAL 记录与日志管理

**WAL（Write-Ahead Logging）** 是 ARIES 算法的基础，它确保所有数据库操作在修改数据之前都已记录到日志中。日志记录不仅是数据库操作的历史记录，还包括日志的顺序号，称为 **LSN（日志序列号）**。

#### LSN 结构

* 每个日志记录都有一个 **LSN**，用来标识这个记录的顺序。
* 每个数据页（数据存储的最小单元）都有一个 **pageLSN**，表示该页的最新更新的 LSN。
* **flushedLSN**：表示已经写入磁盘的日志的最大 LSN。

在崩溃恢复时，系统根据这些 LSN 来判断哪些日志操作已经写入磁盘，哪些操作需要重新执行。

#### 示例：写日志记录

在数据库发生事务提交（commit）时：

1. 事务的操作会写入 **COMMIT** 记录到内存中的日志缓冲区。
2. 所有日志记录（包括 **COMMIT** 记录）被刷新到磁盘。
3. 一旦 **COMMIT** 记录被成功写入磁盘，数据库就会通知客户端事务提交成功。

---

### 4. 事务提交与回滚

#### 事务提交：

事务提交时，DBMS 会：

* 在日志缓冲区写入 **COMMIT** 记录。
* 确保所有的日志记录（包括 **COMMIT** 记录）都被刷新到磁盘。
* 一旦 **COMMIT** 记录成功写入磁盘，DBMS 会确认事务提交。

#### 事务回滚：

当事务回滚时，DBMS 会：

* 通过 **UNDO** 操作撤销事务对数据库做出的修改。
* 为每个撤销操作生成 **CLR（补偿日志记录）**，这是一种特殊的日志记录，用于描述撤销操作。
* 在撤销完事务的所有修改后，DBMS 会写入 **TXN-END** 记录，表示事务已结束。

### 5. Checkpoint（检查点）

**Checkpoint** 是恢复过程中一个重要的概念，它可以帮助系统减少崩溃后需要回放的日志数量。

#### 为什么需要 Checkpoint？

如果没有定期的 Checkpoint，崩溃后 DBMS 必须从日志的头部开始回放，这将非常慢。通过定期的 Checkpoint，DBMS 可以减少恢复时需要重做的日志条目。

**Checkpoint** 可以是：

* **非模糊 Checkpoint**：暂停所有事务，确保将所有数据写入磁盘。
* **稍微好的阻塞 Checkpoint**：暂停新的事务，记录当前状态，但不需要等待所有事务完成。
* **模糊 Checkpoint**（ARIES 使用的方案）：事务可以继续运行，只记录需要的信息（比如活跃事务表和脏页表），在回滚时使用这些信息。

---

### 6. ARIES 恢复的三阶段

ARIES 恢复算法包括 **分析（Analysis）**、**重做（Redo）** 和 **撤销（Undo）** 三个阶段。

#### 1️⃣ 分析阶段（Analysis Phase）

* 从最近的 **Checkpoint** 开始，扫描日志记录以建立 **活跃事务表（ATT）** 和 **脏页表（DPT）**。
* **ATT** 记录崩溃时处于活跃状态的事务。
* **DPT** 记录在内存中修改过但未写入磁盘的数据页。
* 通过分析这些信息，ARIES 了解哪些事务需要重做，哪些需要撤销。

#### 2️⃣ 重做阶段（Redo Phase）

* 从日志中最早的 **recLSN** 开始重做操作。
* 即使是未提交的事务，其已做的修改也会被重做，因为它们可能已修改了数据库的一部分。
* 重做操作的目标是恢复数据库到崩溃前的状态。

#### 3️⃣ 撤销阶段（Undo Phase）

* 在撤销阶段，DBMS 通过 **UNDO** 操作撤销所有未提交的事务。
* 从 **ATT** 中提取所有需要撤销的事务，并按 **lastLSN** 逆序处理。
* 对每个撤销操作，DBMS 生成 **CLR 记录**，记录撤销操作的细节。
* 一旦撤销完成，DBMS 会标记事务为已结束（通过写入 **TXN-END** 记录）。

---

### 7. ARIES 恢复的核心原理

* **分析阶段（Analysis）**：扫描日志，从最后一个检查点（Checkpoint）开始，识别所有脏页和活跃事务。
* **重做阶段（Redo）**：重做所有已提交的事务操作（包括未提交的事务），以确保恢复到崩溃前的状态。
* **撤销阶段（Undo）**：撤销所有未提交的事务，确保只留下已提交的事务操作。

---

### 总结

ARIES 恢复算法通过使用 **Write-Ahead Logging（WAL）** 和详细的 **日志管理**（包括 **LSN** 和 **日志记录**），保证了即使在崩溃的情况下，也能通过 **重做（REDO）** 和 **撤销（UNDO）** 操作恢复数据库的状态。

通过 **Checkpoint** 和 **日志回放**，ARIES 优化了恢复速度，确保了数据库的一致性、原子性和持久性。

