# ä¸€ã€å…ˆæŠŠä¸€å¥è¯è®²é€ï¼šMVCC åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ



> MVCC = æ•°æ®åº“ä¸æ˜¯â€œæ”¹æ‰åŸæ¥çš„æ•°æ®â€ï¼Œ
> è€Œæ˜¯ **æ¯æ¬¡ä¿®æ”¹éƒ½ç•™ä¸€ä»½æ–°å‰¯æœ¬**ï¼Œ
> è¯»çš„äººå„çœ‹å„çš„ç‰ˆæœ¬ï¼Œäº’ä¸æ‰“æ‰°ã€‚

### ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ

å› ä¸ºä¼ ç»Ÿæ•°æ®åº“æ˜¯è¿™æ ·çš„ğŸ‘‡

* ä½ åœ¨è¯»æ•°æ®
* æˆ‘æƒ³æ”¹åŒä¸€æ¡æ•°æ®
* ğŸ‘‰ **è¦ä¹ˆä½ ç­‰æˆ‘ï¼Œè¦ä¹ˆæˆ‘ç­‰ä½ **

è¿™å°±å«ï¼š**è¯»å†™äº’ç›¸é˜»å¡**

MVCC çš„ç›®æ ‡å°±æ˜¯ä¸€å¥è¯ï¼š

> **è¯»ä¸æŒ¡å†™ï¼Œå†™ä¸æŒ¡è¯»**

---

# äºŒã€MVCC çš„æ ¸å¿ƒæ€æƒ³ï¼ˆéå¸¸é‡è¦ï¼‰

## 1ï¸âƒ£ å¤šä¸ªâ€œç‰©ç†ç‰ˆæœ¬â€ï¼Œä¸€ä¸ªâ€œé€»è¾‘å¯¹è±¡â€

æ•°æ®åº“é‡Œé€»è¾‘ä¸Šæ˜¯ **ä¸€æ¡è®°å½•**ï¼Œ
ä½†ç‰©ç†ä¸Šæ˜¯ï¼š

```
ç‰ˆæœ¬ 1ï¼ˆæ—§ï¼‰
ç‰ˆæœ¬ 2
ç‰ˆæœ¬ 3ï¼ˆæ–°ï¼‰
```

æ¯”å¦‚ä¸€æ¡ç”¨æˆ·ä½™é¢ï¼š

| é€»è¾‘ç”¨æˆ· | ç‰©ç†ç‰ˆæœ¬    |
| ---- | ------- |
| ç”¨æˆ·A  | 100ï¼ˆæ—§ï¼‰  |
| ç”¨æˆ·A  | 120     |
| ç”¨æˆ·A  | 150ï¼ˆæœ€æ–°ï¼‰ |

è¿™äº›**éƒ½æ˜¯åŒä¸€ä¸ªç”¨æˆ·**ï¼Œåªæ˜¯ä¸åŒæ—¶é—´çš„ç‰ˆæœ¬ã€‚

---

## 2ï¸âƒ£ äº‹åŠ¡åªçœ‹â€œè‡ªå·±å¼€å§‹é‚£ä¸€åˆ»â€çš„ä¸–ç•Œ

å½“ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶ï¼š

> æ•°æ®åº“ç»™å®ƒæ‹äº†ä¸€å¼  **â€œå…¨ä¸–ç•Œçš„å¿«ç…§â€**

ä¹‹åè¿™ä¸ªäº‹åŠ¡ï¼š

* âŒ çœ‹ä¸åˆ°åæ¥æäº¤çš„ä¿®æ”¹
* âœ… åªçœ‹äº‹åŠ¡å¼€å§‹å‰å·²æäº¤çš„æ•°æ®

è¿™å°±æ˜¯ **Snapshotï¼ˆå¿«ç…§ï¼‰**

---

# ä¸‰ã€MVCC æœ€çˆ½çš„ä¸€ç‚¹ï¼šè¯»å†™ä¸äº’ç›¸å¡æ­»

### æ²¡æœ‰ MVCC çš„ä¸–ç•Œï¼š

* ä½ åœ¨æŸ¥ä½™é¢
* æˆ‘åœ¨æ”¹ä½™é¢
* ğŸ‘‰ å…¶ä¸­ä¸€ä¸ªå¿…é¡»ç­‰

### æœ‰ MVCC çš„ä¸–ç•Œï¼š

* ä½ è¯»çš„æ˜¯ **æ—§ç‰ˆæœ¬**
* æˆ‘å†™çš„æ˜¯ **æ–°ç‰ˆæœ¬**
* ğŸ‘‰ **åŒæ—¶è¿›è¡Œ**

> å†™çš„äººå†™æ–°æœ¬å­
> è¯»çš„äººç¿»æ—§ç¬”è®°
> è°éƒ½ä¸æŠ¢è°çš„çº¸

---

# å››ã€MVCC â‰  åªæ˜¯å¹¶å‘æ§åˆ¶åè®®ï¼ˆé‡ç‚¹ï¼‰

æ–‡æ¡£ç¬¬ä¸€å¥è¯å¾ˆé‡è¦ï¼š

> **MVCC ä¸åªæ˜¯ä¸€ä¸ªå¹¶å‘æ§åˆ¶åè®®**

ä»€ä¹ˆæ„æ€ï¼Ÿ

ğŸ‘‰ å®ƒä¼šå½±å“æ•°æ®åº“çš„ï¼š

1. å­˜å‚¨ç»“æ„
2. ç´¢å¼•
3. åƒåœ¾å›æ”¶
4. åˆ é™¤æ–¹å¼
5. æŸ¥è¯¢é€»è¾‘

æ‰€ä»¥ MVCC æ˜¯ **ä¸€æ•´å¥—æ•°æ®åº“è®¾è®¡å“²å­¦**

---

# äº”ã€MVCC æ˜¯å¦‚ä½•â€œçœ‹ç‰ˆæœ¬â€çš„ï¼Ÿï¼ˆå…³é”®æœºåˆ¶ï¼‰

## 1ï¸âƒ£ ç‰ˆæœ¬ + æ—¶é—´æˆ³

æ¯ä¸ªç‰ˆæœ¬éƒ½ä¼šå¸¦ï¼š

* `begin_ts`ï¼šè¿™ä¸ªç‰ˆæœ¬ä»€ä¹ˆæ—¶å€™ç”Ÿæ•ˆ
* `end_ts`ï¼šä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼ˆè¢«æ–°ç‰ˆæœ¬è¦†ç›–ï¼‰

æ¯ä¸ªäº‹åŠ¡ä¹Ÿæœ‰ï¼š

* `txn_start_ts`

### äº‹åŠ¡è¯»æ•°æ®çš„è§„åˆ™ï¼š

> æ‰¾åˆ°ï¼š
>
> ```
> begin_ts <= txn_start_ts < end_ts
> ```

è¿™æ¡ç‰ˆæœ¬å°±æ˜¯ä½ èƒ½çœ‹åˆ°çš„ã€‚

---

## 2ï¸âƒ£ ä¸ºä»€ä¹ˆè¯»ä¸ç”¨åŠ é”ï¼Ÿ

å› ä¸ºï¼š

* æ•°æ®ä¸ä¼šè¢«è¦†ç›–
* è€ç‰ˆæœ¬æ°¸è¿œè¿˜åœ¨
* ä¸å­˜åœ¨â€œè¯»ä¸€åŠè¢«æ”¹â€çš„é—®é¢˜

---

# å…­ã€Snapshot Isolationï¼ˆå¿«ç…§éš”ç¦»ï¼‰â€”â€”è®²é€

## 1ï¸âƒ£ ä»€ä¹ˆæ˜¯ Snapshot Isolationï¼Ÿ

**é€šä¿—ç‰ˆï¼š**

> äº‹åŠ¡ä»å¼€å§‹åˆ°ç»“æŸï¼Œ
> çœ‹åˆ°çš„æ˜¯ä¸€ä¸ª **å†»ç»“çš„ä¸–ç•Œ**

### ä½ ä¸ä¼šçœ‹åˆ°ï¼š

* åˆ«äººä¸­é€”æäº¤çš„æ•°æ®
* åˆ«äººä¸€åŠæ”¹å®Œçš„æ•°æ®

---

## 2ï¸âƒ£ å†™æ“ä½œå»å“ªäº†ï¼Ÿ

å†™æ“ä½œï¼š

* ä¸ä¼šç«‹åˆ»å½±å“åˆ«äºº
* å†™åœ¨ï¼š

  * ç§æœ‰ç©ºé—´
  * æˆ–å¸¦äº‹åŠ¡ä¿¡æ¯çš„æ–°ç‰ˆæœ¬

åªæœ‰ **commit æˆåŠŸå**ï¼Œ
å…¶ä»–äº‹åŠ¡æ‰èƒ½åœ¨**æœªæ¥çš„å¿«ç…§**ä¸­çœ‹åˆ°ã€‚

---

## 3ï¸âƒ£ å†™å†²çªï¼ˆWrite Conflictï¼‰

ä¸¤ä¸ªäº‹åŠ¡éƒ½æƒ³æ”¹ **åŒä¸€æ¡è®°å½•**ï¼š

* è°å…ˆæäº¤ï¼Œè°èµ¢
* åæäº¤çš„äº‹åŠ¡ç›´æ¥å¤±è´¥ï¼ˆabortï¼‰

ğŸ‘‰ **First Writer Wins**

---

## 4ï¸âƒ£ å†™åæ–œï¼ˆWrite Skewï¼‰â€”â€”éå¸¸å®¹æ˜“è€ƒ

### ä¾‹å­ï¼ˆåŒ»ç”Ÿå€¼ç­ï¼‰ï¼š

è§„åˆ™ï¼š

> è‡³å°‘è¦æœ‰ä¸€ä¸ªåŒ»ç”Ÿå€¼ç­

| åŒ»ç”Ÿ | å€¼ç­ |
| -- | -- |
| A  | æ˜¯  |
| B  | æ˜¯  |

ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œï¼š

* T1ï¼šçœ‹è§ B åœ¨ â†’ è‡ªå·±ä¸‹ç­
* T2ï¼šçœ‹è§ A åœ¨ â†’ è‡ªå·±ä¸‹ç­

**ç»“æœï¼š**

* A ä¸‹ç­
* B ä¸‹ç­
* âŒ è§„åˆ™è¢«ç ´å

ä½† **æ¯ä¸ªäº‹åŠ¡è‡ªå·±çœ‹éƒ½â€œåˆæ³•â€**

ğŸ‘‰ è¿™å°±æ˜¯ **Snapshot Isolation â‰  Serializable**

---

# ä¸ƒã€äº”å¤§ MVCC è®¾è®¡é—®é¢˜ï¼ˆé€ä¸ªæ‹†ï¼‰

---

## 1ï¸âƒ£ å¹¶å‘æ§åˆ¶åè®®ï¼ˆCC Protocolï¼‰

MVCC å¯ä»¥æ­é…ï¼š

* ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰
* æ—¶é—´æˆ³æ’åº
* ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰

ğŸ‘‰ MVCC ä¸æ’æ–¥é”ï¼Œåªæ˜¯ **å‡å°‘é”çš„ä½¿ç”¨èŒƒå›´**

---

## 2ï¸âƒ£ ç‰ˆæœ¬å­˜å‚¨ï¼ˆVersion Storageï¼‰â€”â€”é‡ç‚¹

### æ¯æ¡è®°å½•éƒ½æœ‰ä¸€æ¡â€œç‰ˆæœ¬é“¾â€

```
æœ€æ–°ç‰ˆæœ¬
   â†“
æ—§ç‰ˆæœ¬
   â†“
æ›´æ—§ç‰ˆæœ¬
```

ç´¢å¼•æŒ‡å‘ **é“¾å¤´**

---

### å­˜å‚¨æ–¹æ¡ˆä¸€ï¼šAppend-Onlyï¼ˆè¿½åŠ ï¼‰

* æ–°ç‰ˆæœ¬ç›´æ¥è¿½åŠ 
* æ—§ç‰ˆæœ¬ä¸åŠ¨

#### ä¸¤ç§é“¾é¡ºåºï¼š

1ï¸âƒ£ Old â†’ New

* æŸ¥è¦ä¸€è·¯èµ°

2ï¸âƒ£ New â†’ Oldï¼ˆæ›´å¸¸è§ï¼‰

* ç´¢å¼•ç›´æ¥æŒ‡å‘æœ€æ–°

---

### å­˜å‚¨æ–¹æ¡ˆäºŒï¼šTime-Travel Table

* ä¸»è¡¨åªå­˜æœ€æ–°
* è€ç‰ˆæœ¬ä¸¢åˆ°â€œå†å²è¡¨â€

å°±åƒï¼š

* æ¡£æ¡ˆæŸœï¼šå½“å‰æ–‡ä»¶
* ä»“åº“ï¼šå†å²æ¡£æ¡ˆ

---

### å­˜å‚¨æ–¹æ¡ˆä¸‰ï¼šDelta Storage

* ä¸å­˜å®Œæ•´è€ç‰ˆæœ¬
* åªå­˜â€œæ”¹äº†ä»€ä¹ˆâ€

ä¾‹å¦‚ï¼š

```
+10
-5
```

ä¼˜ç‚¹ï¼šå†™å¿«
ç¼ºç‚¹ï¼šè¯»æ…¢ï¼ˆè¦å€’æ¨ï¼‰

---

## 3ï¸âƒ£ åƒåœ¾å›æ”¶ï¼ˆGCï¼‰â€”â€”ä¸ç„¶ä¼šç‚¸ç›˜

### ä»€ä¹ˆæ—¶å€™èƒ½åˆ ç‰ˆæœ¬ï¼Ÿ

* æ²¡æœ‰ä»»ä½•æ´»è·ƒäº‹åŠ¡èƒ½çœ‹åˆ°
* æˆ–äº‹åŠ¡å·² abort

---

### Tuple-Level GC

#### åå° Vacuum

* æ‰«è¡¨
* æ¸…è€ç‰ˆæœ¬

ä¼˜åŒ–ï¼š

* åªæ‰«â€œè„é¡µâ€

#### åä½œæ¸…ç†

* è®¿é—®æ—¶é¡ºä¾¿æ¸…
* åªé€‚åˆ Oldâ†’New é“¾

---

### Transaction-Level GCï¼ˆé«˜çº§ï¼‰

* æ¯ä¸ªäº‹åŠ¡è®°å½•è‡ªå·±æ”¹äº†å•¥
* äº‹åŠ¡ç»“æŸæ—¶ï¼š

  * ç³»ç»Ÿåˆ¤æ–­æ˜¯å¦è¿˜èƒ½è¢«çœ‹åˆ°
  * ä¸èƒ½ â†’ å›æ”¶

ğŸ‘‰ PostgreSQL åçˆ± Vacuum
ğŸ‘‰ ä¸€äº›æ–°ç³»ç»Ÿåäº‹åŠ¡çº§

---

## 4ï¸âƒ£ ç´¢å¼•ç®¡ç†ï¼ˆè¶…çº§éº»çƒ¦ï¼‰

### ä¸»é”®ç´¢å¼•

* æ°¸è¿œæŒ‡å‘ç‰ˆæœ¬é“¾å¤´
* æ”¹ä¸»é”® = åˆ é™¤ + æ’å…¥

---

### äºŒçº§ç´¢å¼•ï¼šä¸¤ç§æ–¹æ¡ˆ

#### é€»è¾‘æŒ‡é’ˆï¼ˆæ¨èï¼‰

```
äºŒçº§ç´¢å¼• â†’ é€»è¾‘ID â†’ ä¸»ç´¢å¼• â†’ ç‰ˆæœ¬é“¾
```

ä¼˜ç‚¹ï¼š

* æ›´æ–°åªåŠ¨ä¸€å¤„

---

#### ç‰©ç†æŒ‡é’ˆï¼ˆå¾ˆè´µï¼‰

```
äºŒçº§ç´¢å¼• â†’ ç‰©ç†åœ°å€
```

æ¯æ¬¡æ–°ç‰ˆæœ¬ï¼š

* æ‰€æœ‰ç´¢å¼•éƒ½è¦æ›´æ–°

ğŸ‘‰ ç´¢å¼•å¤š = åœ°ç‹±

---

## MVCC é‡å¤é”®é—®é¢˜ï¼ˆé‡ç‚¹ï¼‰

ç´¢å¼•é‡Œï¼š

* åŒä¸€ä¸ª key
* å¯èƒ½å¯¹åº” **å¤šä¸ªç‰ˆæœ¬**

æ‰€ä»¥ï¼š

* æŸ¥è¯¢å¯èƒ½è¿”å›å¤šä¸ª
* å†æ ¹æ®ç‰ˆæœ¬åˆ¤æ–­å¯è§æ€§

---

## 5ï¸âƒ£ åˆ é™¤ï¼ˆDeleteï¼‰ä¸æ˜¯ç«‹åˆ»æ¶ˆå¤±

### ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥åˆ ï¼Ÿ

å› ä¸ºï¼š

* å¯èƒ½æœ‰è€äº‹åŠ¡è¿˜è¦çœ‹

---

### åˆ é™¤æ–¹æ¡ˆä¸€ï¼šDeleted Flag

* æ ‡è®°â€œå·²åˆ â€
* ä½†ç‰©ç†è¿˜åœ¨

---

### åˆ é™¤æ–¹æ¡ˆäºŒï¼šå¢“ç¢‘ï¼ˆTombstoneï¼‰

* æ’å…¥ä¸€ä¸ªâ€œç©ºç‰ˆæœ¬â€
* è¡¨ç¤ºï¼šä»æ­¤ä»¥åä¸å¯è§

---

# å…«ã€æœ€ç»ˆæ€»ç»“ï¼ˆé€ä½ ä¸€å¥è¯ï¼‰

> **MVCC çš„æœ¬è´¨æ˜¯ï¼š**
>
> ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œ
> ç”¨ç‰ˆæœ¬æ¢å¹¶å‘ï¼Œ
> ç”¨å¤æ‚å®ç°æ¢ç®€å•ä½¿ç”¨ã€‚


