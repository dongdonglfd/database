>SQL 是一种 声明式（Declarative）查询语言，用于关系数据库。

# 一、SQL 包含哪些类型的命令？

1. DDL (数据定义语言)
作用：定义和管理数据库中的各种结构或模式对象。这些语句隐式提交事务
2. DML (数据操作语言)
作用：对表中的数据进行增、删、改操作
3. DQL (数据查询语言)
作用：从数据库中检索数据。它是SQL中使用频率最高的部分
4. DCL (数据控制语言)
作用：控制数据库的访问权限和安全性。
# 二、DDL
1. 数据库级别操作

```sql
CREATE DATABASE - 创建数据库
-- 基本语法
CREATE DATABASE 数据库名;
-- 创建学校数据库
CREATE DATABASE school_db;
-- 高级选项：指定字符集和排序规则
CREATE DATABASE company_db
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;
-- 判断不存在时创建（MySQL语法）
CREATE DATABASE IF NOT EXISTS test_db;
ALTER DATABASE - 修改数据库
-- 修改数据库字符集
ALTER DATABASE school_db
CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;
-- 修改数据库名称（SQL Server）
ALTER DATABASE old_name MODIFY NAME = new_name;
DROP DATABASE - 删除数据库
-- 删除数据库
DROP DATABASE test_db;
-- 安全删除：先检查是否存在
DROP DATABASE IF EXISTS test_db;
切换/使用数据库
-- 切换当前操作的数据库
USE school_db;
-- PostgreSQL使用
\c school_db
```
2. 表级别操作（最常用）
```sql
CREATE TABLE - 创建表
-- 创建学生表
CREATE TABLE Students (
    student_id INT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    gender CHAR(1) CHECK (gender IN ('M', 'F')),
    birth_date DATE,
    enrollment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    email VARCHAR(100) UNIQUE
);

-- 带外键的课程表
CREATE TABLE Courses (
    course_id INT PRIMARY KEY,
    course_name VARCHAR(100) NOT NULL,
    credit DECIMAL(3, 1),
    teacher_id INT,
    FOREIGN KEY (teacher_id) REFERENCES Teachers(teacher_id)
);

-- 创建表时指定存储引擎（MySQL）
CREATE TABLE Orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    order_date DATE
) ENGINE=InnoDB;

-- 复制表结构
CREATE TABLE Students_Backup LIKE Students;
ALTER TABLE - 修改表结构
-- 1. 添加列
ALTER TABLE Students ADD COLUMN phone VARCHAR(20);

-- 2. 删除列
ALTER TABLE Students DROP COLUMN birth_date;

-- 3. 修改列定义
ALTER TABLE Students MODIFY COLUMN name VARCHAR(100) NOT NULL;
ALTER TABLE Students ALTER COLUMN name TYPE VARCHAR(100); -- PostgreSQL

-- 4. 重命名列
ALTER TABLE Students RENAME COLUMN student_id TO id;  -- MySQL
ALTER TABLE Students RENAME COLUMN student_id TO id; -- SQL Server
ALTER TABLE Students RENAME student_id TO id;         -- Oracle

-- 5. 重命名表
ALTER TABLE OldStudents RENAME TO NewStudents;
RENAME TABLE OldStudents TO NewStudents;  -- MySQL专用语法

-- 6. 修改列的默认值
ALTER TABLE Students ALTER COLUMN enrollment_date SET DEFAULT NOW();
ALTER TABLE Students ALTER COLUMN enrollment_date DROP DEFAULT;
DROP TABLE - 删除表
-- 删除表
DROP TABLE Students;

-- 级联删除（删除表及其依赖对象）
DROP TABLE Students CASCADE;  -- PostgreSQL

-- 安全删除
DROP TABLE IF EXISTS Students;
TRUNCATE TABLE - 快速清空表
-- 清空表数据但保留表结构
TRUNCATE TABLE Logs;

-- 重置自增ID（MySQL）
TRUNCATE TABLE Orders;
-- 注意：TRUNCATE不可回滚，DELETE可回滚
```

# 三、DML
1. INSERT - 插入数据
```sql
-- 1.1 插入单行（指定列）
INSERT INTO Students (student_id, name, age, major)
VALUES (1, '张三', 20, '计算机科学');

-- 1.2 插入单行（省略列名，需为所有列提供值）
INSERT INTO Students 
VALUES (2, '李四', 21, '男', '数学');

-- 1.3 插入多行
INSERT INTO Students (student_id, name, age, major) VALUES
(3, '王五', 19, '物理'),
(4, '赵六', 22, '化学'),
(5, '钱七', 20, '生物');

-- 1.4 插入查询结果
INSERT INTO Graduated_Students (student_id, name, graduation_year)
SELECT student_id, name, 2024
FROM Students 
WHERE status = 'graduated';

-- 1.5 使用DEFAULT值
CREATE TABLE Orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    order_date DATE DEFAULT CURRENT_DATE,
    status VARCHAR(20) DEFAULT 'pending'
);

INSERT INTO Orders (order_id) VALUES (DEFAULT);
-- 或
INSERT INTO Orders DEFAULT VALUES;
```

2. UPDATE - 更新数据
```sql
-- 2.1 更新单行
UPDATE Students 
SET age = 21, major = '软件工程'
WHERE student_id = 1;

-- 2.2 更新多行
UPDATE Students 
SET status = 'active'
WHERE enrollment_year = 2023;

-- 2.3 基于表达式更新
UPDATE Employees 
SET salary = salary * 1.1,  -- 涨薪10%
    last_raise_date = CURRENT_DATE
WHERE department = '研发部';

-- 2.4 使用子查询更新
UPDATE Orders 
SET discount = 0.1
WHERE customer_id IN (
    SELECT customer_id 
    FROM Customers 
    WHERE membership_level = 'gold'
);

-- 2.5 关联更新（多表更新）
-- MySQL
UPDATE Orders o
JOIN Customers c ON o.customer_id = c.customer_id
SET o.priority = 'high'
WHERE c.total_purchases > 10000;

-- SQL Server
UPDATE o
SET priority = 'high'
FROM Orders o
JOIN Customers c ON o.customer_id = c.customer_id
WHERE c.total_purchases > 10000;

-- Oracle
UPDATE Orders o
SET priority = 'high'
WHERE EXISTS (
    SELECT 1 
    FROM Customers c 
    WHERE c.customer_id = o.customer_id 
    AND c.total_purchases > 10000
);
```

3. DELETE - 删除数据
```sql
-- 3.1 删除特定行
DELETE FROM Students 
WHERE student_id = 1;

-- 3.2 删除满足条件的所有行
DELETE FROM Logs 
WHERE log_date < '2024-01-01';

-- 3.3 删除所有行（清空表）
DELETE FROM Students;  -- 可回滚

-- 3.4 使用子查询删除
DELETE FROM Orders 
WHERE customer_id IN (
    SELECT customer_id 
    FROM Customers 
    WHERE status = 'inactive'
);

-- 3.5 关联删除
-- MySQL
DELETE o
FROM Orders o
JOIN Customers c ON o.customer_id = c.customer_id
WHERE c.country = 'USA';

-- SQL Server
DELETE FROM o
FROM Orders o
JOIN Customers c ON o.customer_id = c.customer_id
WHERE c.country = 'USA';

-- PostgreSQL/Oracle
DELETE FROM Orders o
WHERE EXISTS (
    SELECT 1 
    FROM Customers c 
    WHERE c.customer_id = o.customer_id 
    AND c.country = 'USA'
);
```
# 四、DQL
1. SELECT 基础查询
 基本语法结构
```sql
-- 最简单的查询
SELECT * FROM employees;

-- 指定列查询
SELECT first_name, last_name, salary FROM employees;

-- 使用表别名
SELECT e.first_name, e.last_name FROM employees AS e;
-- 或简写
SELECT e.first_name, e.last_name FROM employees e;
```
 去重查询
```sql
-- DISTINCT 去重
SELECT DISTINCT department FROM employees;
SELECT DISTINCT city, state FROM customers;  -- 组合去重
```
2. WHERE 条件筛选
比较运算符
```sql
-- 基本比较
SELECT * FROM products WHERE price > 100;
SELECT * FROM products WHERE price <= 50;
SELECT * FROM products WHERE price = 29.99;
SELECT * FROM products WHERE price != 29.99;  -- 或 <>
SELECT * FROM products WHERE price BETWEEN 10 AND 100;  -- 包含边界
SELECT * FROM products WHERE price NOT BETWEEN 10 AND 100;

-- 字符串比较
SELECT * FROM products WHERE name = 'iPhone';
SELECT * FROM products WHERE name LIKE 'iPhone%';  -- 以iPhone开头
SELECT * FROM products WHERE name LIKE '%Phone%';  -- 包含Phone
SELECT * FROM products WHERE name LIKE 'iP_one';   -- _匹配单个字符
SELECT * FROM products WHERE name NOT LIKE '%test%';
```
逻辑运算符
```sql
-- AND, OR, NOT
SELECT * FROM employees 
WHERE department = 'Sales' AND salary > 50000;

SELECT * FROM employees 
WHERE department = 'Sales' OR department = 'Marketing';

SELECT * FROM employees 
WHERE NOT department = 'HR';

SELECT * FROM products
WHERE (category = 'Electronics' OR category = 'Computers')
  AND price > 1000
  AND stock_quantity > 0;
  ```
 NULL 值处理
```sql
-- 错误：不能使用 = NULL
SELECT * FROM employees WHERE manager_id = NULL;  -- 错误！

-- 正确：使用 IS NULL
SELECT * FROM employees WHERE manager_id IS NULL;

-- IS NOT NULL
SELECT * FROM employees WHERE email IS NOT NULL;

-- 与COALESCE结合使用
SELECT 
    first_name,
    COALESCE(phone, 'N/A') AS phone,  -- 如果phone为NULL，显示'N/A'
    COALESCE(bonus, 0) AS bonus
FROM employees;
2.4 IN 和 NOT IN
-- IN 运算符
SELECT * FROM products 
WHERE category IN ('Electronics', 'Books', 'Clothing');

SELECT * FROM employees
WHERE department_id IN (SELECT id FROM departments WHERE location = 'NYC');

-- NOT IN
SELECT * FROM customers
WHERE country NOT IN ('USA', 'Canada', 'Mexico');
```
3. ORDER BY 排序
基本排序
```sql
-- 单列排序
SELECT * FROM products ORDER BY price ASC;  -- 升序（默认）
SELECT * FROM products ORDER BY price DESC; -- 降序

-- 多列排序
SELECT * FROM employees 
ORDER BY department ASC, salary DESC, last_name ASC;

-- 按表达式排序
SELECT * FROM products 
ORDER BY price * stock_quantity DESC;  -- 按库存总价值排序

-- 按列位置排序（不推荐，可读性差）
SELECT name, price, quantity 
FROM products 
ORDER BY 2 DESC, 3 ASC;  -- 2表示price列，3表示quantity列
```
4. 聚合函数和GROUP BY
常用聚合函数
```sql
-- 计数
SELECT COUNT(*) FROM employees;  -- 所有行数
SELECT COUNT(email) FROM employees;  -- 非NULL的行数
SELECT COUNT(DISTINCT department) FROM employees;  -- 去重计数

-- 求和、平均
SELECT 
    SUM(salary) AS total_salary,
    AVG(salary) AS avg_salary,
    MIN(salary) AS min_salary,
    MAX(salary) AS max_salary
FROM employees;

-- 其他聚合函数
SELECT 
    VARIANCE(salary) AS salary_variance,  -- 方差
    STDDEV(salary) AS salary_stddev,      -- 标准差
    MEDIAN(salary) AS salary_median       -- 中位数（部分数据库支持）
FROM employees;
```
GROUP BY 分组
```sql
-- 基本分组
SELECT 
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary
FROM employees
GROUP BY department;

-- 多列分组
SELECT 
    department,
    gender,
    COUNT(*) AS count,
    AVG(salary) AS avg_salary
FROM employees
GROUP BY department, gender;

-- 分组后过滤 HAVING
SELECT 
    department,
    AVG(salary) AS avg_salary
FROM employees
GROUP BY department
HAVING AVG(salary) > 50000;  -- 平均工资大于50000的部门

-- 与WHERE的区别
SELECT 
    department,
    AVG(salary) AS avg_salary
FROM employees
WHERE hire_date > '2020-01-01'  -- 先过滤行
GROUP BY department
HAVING AVG(salary) > 50000;     -- 再过滤分组
```
5. 分页查询
```sql
-- MySQL
SELECT * FROM products
ORDER BY product_id
LIMIT 10 OFFSET 20;  -- 跳过20条，取10条

-- PostgreSQL
SELECT * FROM products
ORDER BY product_id
LIMIT 10 OFFSET 20;

-- SQL Server
SELECT * FROM products
ORDER BY product_id
OFFSET 20 ROWS FETCH NEXT 10 ROWS ONLY;

-- Oracle
SELECT * FROM (
    SELECT t.*, ROWNUM AS rn
    FROM (
        SELECT * FROM products ORDER BY product_id
    ) t
    WHERE ROWNUM <= 30
) WHERE rn > 20;
```
# 五、DCL
1. 权限管理基础概念
 权限层级结构
```sql
数据库实例 (Instance)
    ↓
数据库 (Database)
    ↓
模式/架构 (Schema)
    ↓
对象 (Tables, Views, Procedures, etc.)
    ↓
列 (Columns)
```
权限类型
```sql
-- 系统权限：对整个数据库的操作权限
CREATE, ALTER, DROP, BACKUP, RESTORE, SHUTDOWN

-- 对象权限：对特定数据库对象的操作权限
SELECT, INSERT, UPDATE, DELETE, EXECUTE, REFERENCES, ALL PRIVILEGES

-- 列级权限：对表中特定列的操作权限
SELECT, UPDATE, REFERENCES
```
2. 用户管理
 创建用户
```sql
-- MySQL
CREATE USER 'john_doe'@'localhost' IDENTIFIED BY 'secure_password123';
CREATE USER 'app_user'@'192.168.1.%' IDENTIFIED BY 'app_pass';  -- 允许IP段
CREATE USER 'readonly'@'%' IDENTIFIED BY 'readonly_pass';  -- 允许任何主机

-- PostgreSQL
CREATE USER john_doe WITH PASSWORD 'secure_password123';
CREATE USER app_user WITH PASSWORD 'app_pass' VALID UNTIL '2025-12-31';  -- 设置过期时间

-- SQL Server
CREATE LOGIN john_doe WITH PASSWORD = 'secure_password123';
CREATE USER john_doe FOR LOGIN john_doe;

-- Oracle
CREATE USER john_doe 
IDENTIFIED BY secure_password123
DEFAULT TABLESPACE users
TEMPORARY TABLESPACE temp
QUOTA 100M ON users
PASSWORD EXPIRE;  -- 首次登录需修改密码
```
修改用户
```sql
-- 修改密码
-- MySQL
ALTER USER 'john_doe'@'localhost' IDENTIFIED BY 'new_password123';
SET PASSWORD FOR 'john_doe'@'localhost' = PASSWORD('new_password123');

-- PostgreSQL
ALTER USER john_doe WITH PASSWORD 'new_password123';

-- SQL Server
ALTER LOGIN john_doe WITH PASSWORD = 'new_password123';

-- 修改用户属性
ALTER USER john_doe 
ACCOUNT LOCK;  -- 锁定账户

ALTER USER john_doe 
ACCOUNT UNLOCK;  -- 解锁账户

ALTER USER john_doe 
VALID UNTIL '2025-12-31';  -- 设置账户过期时间

-- 重命名用户
-- MySQL
RENAME USER 'old_user'@'localhost' TO 'new_user'@'localhost';

-- PostgreSQL
ALTER USER old_user RENAME TO new_user;
```
删除用户
```sql
-- MySQL
DROP USER 'john_doe'@'localhost';
DROP USER IF EXISTS 'john_doe'@'localhost';  -- 安全删除

-- PostgreSQL
DROP USER john_doe;
DROP USER IF EXISTS john_doe;

-- SQL Server
DROP USER john_doe;
DROP LOGIN john_doe;  -- 需要先删除用户，再删除登录

-- Oracle
DROP USER john_doe CASCADE;  -- 级联删除用户的所有对象
```
3. GRANT - 授予权限
授予系统权限
```sql
-- MySQL
-- 授予所有数据库的权限
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'localhost' WITH GRANT OPTION;

-- 授予特定数据库的所有权限
GRANT ALL PRIVILEGES ON company_db.* TO 'db_admin'@'localhost';

-- 授予特定权限
GRANT CREATE, DROP, ALTER ON *.* TO 'dba'@'localhost';
GRANT CREATE USER, PROCESS, RELOAD ON *.* TO 'super_admin'@'localhost';

-- PostgreSQL
GRANT ALL PRIVILEGES ON DATABASE company_db TO db_admin;
GRANT CREATE ON DATABASE company_db TO schema_creator;

-- SQL Server
GRANT CREATE ANY DATABASE TO db_admin;
GRANT ALTER ANY LOGIN TO security_admin;
GRANT VIEW SERVER STATE TO monitor_user;

-- Oracle
GRANT CREATE SESSION TO app_user;  -- 允许连接数据库
GRANT CREATE TABLE TO schema_owner;
GRANT UNLIMITED TABLESPACE TO data_owner;  -- 无限制表空间
```
4. REVOKE - 回收权限
```sql
-- MySQL
REVOKE ALL PRIVILEGES ON *.* FROM 'admin'@'localhost';
REVOKE CREATE, DROP ON company_db.* FROM 'temp_admin'@'localhost';

-- PostgreSQL
REVOKE CREATE ON DATABASE company_db FROM schema_creator;

-- SQL Server
REVOKE CREATE ANY DATABASE FROM db_admin;

-- Oracle
REVOKE CREATE TABLE FROM schema_owner;
REVOKE UNLIMITED TABLESPACE FROM data_owner;

```
5. 权限查询
查看用户权限
```sql
-- MySQL
-- 查看用户权限
SHOW GRANTS FOR 'john_doe'@'localhost';

-- 查看当前用户权限
SHOW GRANTS;
SHOW GRANTS FOR CURRENT_USER();

-- 查看所有用户权限
SELECT * FROM mysql.user;
SELECT 
    User, 
    Host, 
    Grant_priv, 
    Select_priv, 
    Insert_priv 
FROM mysql.user;

-- PostgreSQL
-- 查看用户权限
\du  -- 在psql中
SELECT * FROM pg_roles;
SELECT * FROM pg_user;

-- 查看表权限
SELECT 
    grantee,
    table_schema,
    table_name,
    privilege_type
FROM information_schema.table_privileges
WHERE table_name = 'employees';

-- SQL Server
-- 查看用户权限
EXEC sp_helprotect NULL, 'john_doe';

-- 查看对象权限
SELECT 
    USER_NAME(grantee_principal_id) AS grantee,
    OBJECT_NAME(major_id) AS object_name,
    permission_name,
    state_desc
FROM sys.database_permissions
WHERE class = 1  -- 对象类
ORDER BY grantee, object_name;

-- Oracle
-- 查看用户权限
SELECT * FROM dba_sys_privs WHERE grantee = 'HR_MANAGER';
SELECT * FROM dba_tab_privs WHERE grantee = 'HR_MANAGER';

-- 查看当前会话权限
SELECT * FROM session_privs;
```


