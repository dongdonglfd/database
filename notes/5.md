# ä¸€ã€DBMS é‡Œä¸ºä»€ä¹ˆå¤§é‡ç”¨æ•°æ®ç»“æ„ï¼Ÿ

æ•°æ®åº“ä¸æ˜¯åªå­˜æ•°æ®ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå¤æ‚çš„è½¯ä»¶ç³»ç»Ÿã€‚

 **DBMS ç”¨æ•°æ®ç»“æ„çš„åœ°æ–¹**
ï¼ˆ1ï¼‰å†…éƒ¨å…ƒæ•°æ®ï¼ˆInternal Meta-Dataï¼‰

ğŸ‘‰ ç”¨æ¥ ç®¡ç†æ•°æ®åº“è‡ªå·±

Page Tableï¼ˆé¡µè¡¨ï¼‰

Page Directoryï¼ˆé¡µç›®å½•ï¼‰

Buffer Pool çš„æ˜ å°„è¡¨

è¿™äº›ç»“æ„æœ¬èº«ä¸æ˜¯ç”¨æˆ·æ•°æ®ï¼Œä½†å†³å®š DBMS èƒ½ä¸èƒ½è·‘å¾—å¿«ã€ç¨³ã€‚

ï¼ˆ2ï¼‰æ ¸å¿ƒæ•°æ®å­˜å‚¨ï¼ˆCore Data Storageï¼‰

ğŸ‘‰ çœŸæ­£å­˜ tupleï¼ˆè¡Œï¼‰

Heap File

B+Tree å¶å­èŠ‚ç‚¹

Index Page

ï¼ˆ3ï¼‰ä¸´æ—¶æ•°æ®ç»“æ„ï¼ˆTemporary Data Structuresï¼‰

ğŸ‘‰ æ‰§è¡ŒæŸ¥è¯¢æ—¶ä¸´æ—¶å»ºçš„

Join ç”¨çš„ hash table

Group By ç”¨çš„ hash table

å»é‡ã€èšåˆ

âš ï¸ ç‰¹ç‚¹ï¼š

ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­

åªå­˜åœ¨äºä¸€æ¬¡æŸ¥è¯¢ä¸­

ä¸éœ€è¦æŒä¹…åŒ–åˆ°ç£ç›˜

ï¼ˆ4ï¼‰è¡¨ç´¢å¼•ï¼ˆTable Indicesï¼‰

ğŸ‘‰ ç”¨äºå¿«é€Ÿå®šä½ tuple

Hash Index

B+Tree Index

 **DBMS å®ç°æ•°æ®ç»“æ„çš„ä¸¤å¤§è®¾è®¡ç»´åº¦**
â‘  æ•°æ®ç»„ç»‡æ–¹å¼ï¼ˆData Organizationï¼‰

è¦è€ƒè™‘ï¼š

æ˜¯ å†…å­˜ç»“æ„ è¿˜æ˜¯ ç£ç›˜ç»“æ„

é¡ºåºè®¿é—® vs éšæœºè®¿é—®

cache å‹ä¸å‹å¥½

âš ï¸ DBMS å’Œæ™®é€šç¨‹åºä¸ä¸€æ ·ï¼š

åœ¨ç£ç›˜ä¸Šï¼šé¡ºåºè®¿é—®æ¯”éšæœºè®¿é—®å¿«å¾—å¤š

æœ‰äº›â€œå†…å­˜é‡Œçœ‹èµ·æ¥å¾ˆæ…¢â€çš„ç»“æ„ï¼Œåœ¨ç£ç›˜ä¸Šåè€Œæ›´å¥½

â‘¡ å¹¶å‘ï¼ˆConcurrencyï¼‰

å¤šçº¿ç¨‹ä¼šåŒæ—¶è®¿é—®æ•°æ®ç»“æ„

éœ€è¦ latch / lock

æ—¢è¦å¿«ï¼Œåˆä¸èƒ½é”™

# äºŒã€ä»€ä¹ˆæ˜¯ Hash Tableï¼ˆåœ¨ DBMS è¯­å¢ƒä¸‹ï¼‰
 **Hash Table çš„æœ¬è´¨**

Hash Table = Key â†’ Value çš„æ˜ å°„ç»“æ„

å¹³å‡æ—¶é—´å¤æ‚åº¦ï¼šO(1)

æœ€åæƒ…å†µï¼šO(n)

ç©ºé—´å¤æ‚åº¦ï¼šO(n)

âš ï¸ é‡è¦ç‰¹æ€§ï¼š

æ²¡æœ‰é¡ºåº

ä¸èƒ½èŒƒå›´æ‰«æ

åªèƒ½â€œæŒ‰ key æ‰¾â€

ğŸ‘‰ æ‰€ä»¥ï¼š

Hash Table é€‚åˆ ç­‰å€¼æŸ¥è¯¢

ä¸é€‚åˆ >, <, BETWEEN

**Hash Table çš„ä¸¤ä¸ªæ ¸å¿ƒç»„æˆ**
ï¼ˆ1ï¼‰Hash Functionï¼ˆå“ˆå¸Œå‡½æ•°ï¼‰

è´Ÿè´£ï¼š
```c
Key â†’ Integer Hash Value
```

è®¾è®¡ç›®æ ‡æ˜¯ æŠ˜ä¸­ï¼š

å¤ªç®€å• â†’ å†²çªå¤š

å¤ªå¤æ‚ â†’ ç®—å¾—æ…¢

 DBMS ä¸éœ€è¦åŠ å¯†å“ˆå¸Œï¼ˆSHA-256 ä¹‹ç±»ï¼‰
ğŸ‘‰ åªå…³å¿ƒï¼š

å¿«

å†²çªå°‘

ç›®å‰å·¥ä¸šçº§æœ€å¼ºï¼š

XXHash3ï¼ˆFacebookï¼‰

ï¼ˆ2ï¼‰Hashing Schemeï¼ˆå†²çªè§£å†³æ–¹æ¡ˆï¼‰

å½“ï¼š
```c
hash(key1) == hash(key2)
```

æ€ä¹ˆåŠï¼Ÿ

ğŸ‘‰ Hashing Scheme å†³å®š å†²çªåçš„å¤„ç†æ–¹å¼
# ä¸‰ã€é™æ€å“ˆå¸Œï¼ˆStatic Hashingï¼‰
**ä»€ä¹ˆå«â€œé™æ€â€**

å“ˆå¸Œè¡¨å¤§å° æå‰å›ºå®š

æ”¾æ»¡äº† â†’ æ•´ä½“é‡å»º

é€šå¸¸æ‰©å®¹ = ç¿»å€

âš ï¸ é—®é¢˜ï¼š

DBMS é€šå¸¸ä¸çŸ¥é“å…ƒç´ æ•°é‡

é‡å»ºå“ˆå¸Œè¡¨éå¸¸è´µï¼ˆè¦æ¬æ‰€æœ‰æ•°æ®ï¼‰

**ç°å®ä¸­å¾ˆéš¾æ»¡è¶³çš„å‡è®¾**

é™æ€å“ˆå¸Œå‡è®¾ï¼š

å…ƒç´ æ•°é‡å›ºå®š âŒ

key å”¯ä¸€ âŒ

å®Œç¾å“ˆå¸Œ âŒ

ğŸ‘‰ æ‰€ä»¥éœ€è¦ æ›´èªæ˜çš„æ–¹æ¡ˆ
# å››ã€Linear Probingï¼ˆçº¿æ€§æ¢æµ‹å“ˆå¸Œï¼‰
è¿™æ˜¯ DBMS é‡Œæœ€å¸¸è§ã€æœ€å¿«çš„ä¸€ç§

 **åŸºæœ¬æ€æƒ³**

ä¸€ä¸ªæ•°ç»„ï¼ˆå¾ªç¯ï¼‰

hash(key) â†’ æŸä¸ª slot

å¦‚æœè¢«å äº† â†’ å¾€åä¸€ä¸ªä¸€ä¸ªæ‰¾

slot i â†’ i+1 â†’ i+2 â†’ ... â†’ ç©ºä½

**ä¸ºä»€ä¹ˆ DBMS å¾ˆçˆ±å®ƒï¼Ÿ**

âœ… ä¼˜ç‚¹ï¼š

ä¸éœ€è¦æŒ‡é’ˆ

å†…å­˜è¿ç»­

cache å‹å¥½

å®ç°ç®€å•ã€é€Ÿåº¦å¿«

âŒ ç¼ºç‚¹ï¼š

ä¸»èšé›†ï¼ˆPrimary Clusteringï¼‰

load factor é«˜æ—¶æ€§èƒ½æ€¥å‰§ä¸‹é™

**ä¸‰ä¸ªæ“ä½œçš„ç»†èŠ‚**
ğŸ”¹ æ’å…¥ï¼ˆInsertï¼‰

hash åˆ° slot

å¦‚æœå†²çª â†’ çº¿æ€§å¾€åæ‰¾

æ‰¾åˆ°ç©ºä½æ’å…¥

ğŸ”¹ æŸ¥è¯¢ï¼ˆLookupï¼‰

hash åˆ° slot

ä»è¯¥ä½ç½®çº¿æ€§æ‰«æ

æ‰¾åˆ° key â†’ è¿”å›

é‡åˆ° çœŸæ­£ç©ºä½ â†’ key ä¸å­˜åœ¨

âš ï¸ æ‰€ä»¥ï¼š

slot é‡Œå¿…é¡»å­˜ key

ä¸èƒ½åªå­˜ value

ğŸ”¹ åˆ é™¤ï¼ˆDeleteï¼‰â€”â€”æœ€éº»çƒ¦
âŒ ä¸èƒ½ç›´æ¥æ¸…ç©º slot

å¦åˆ™ï¼š

åé¢è¢«æŒ¤è¿‡æ¥çš„ key ä¼šâ€œæ–­é“¾â€

æŸ¥æ‰¾å¤±è´¥

âœ… æ–¹æ¡ˆ 1ï¼šTombstoneï¼ˆå¢“ç¢‘ï¼‰ã€æœ€å¸¸è§ã€‘

åˆ é™¤æ—¶æ ‡è®°ä¸ºâ€œå¢“ç¢‘â€

æŸ¥è¯¢é‡åˆ°å¢“ç¢‘ â†’ ç»§ç»­æŸ¥

æ’å…¥å¯ä»¥å¤ç”¨å¢“ç¢‘

ç¼ºç‚¹ï¼šå¢“ç¢‘å¤šäº†æ€§èƒ½ä¸‹é™

âŒ æ–¹æ¡ˆ 2ï¼šæ•´ä½“æ¬ç§»

åˆ é™¤åï¼ŒæŠŠåé¢â€œè¢«æŒ¤è¿‡â€çš„å…ƒç´ å¾€å‰æŒª

éå¸¸å¤æ‚ + éå¸¸æ…¢

å‡ ä¹æ²¡äººç”¨

 **Key / Value æ€ä¹ˆå­˜ï¼Ÿ**
ï¼ˆ1ï¼‰å®šé•¿ Key / Value

ç›´æ¥æ”¾åœ¨ slot é‡Œ

å¯èƒ½é¡ºå¸¦å­˜ hash å€¼

ï¼ˆ2ï¼‰å˜é•¿ Key / Valueï¼ˆæ›´å¸¸è§ï¼‰

å®é™…æ•°æ®å­˜åœ¨ ä¸´æ—¶è¡¨

å“ˆå¸Œè¡¨é‡Œå­˜ï¼š

hash + record_id

 **éå”¯ä¸€ Key æ€ä¹ˆåŠï¼Ÿ**
æ–¹æ³• 1ï¼šé“¾è¡¨

æ¯ä¸ª key æŒ‡å‘ value list

ä¼šå˜æ…¢

æ–¹æ³• 2ï¼šå†—ä½™ keyï¼ˆæ›´å¸¸è§ï¼‰

ç›¸åŒ key æ’å¤šæ¬¡

çº¿æ€§æ¢æµ‹ç…§æ ·å·¥ä½œ
# äº”ã€Cuckoo Hashingï¼ˆå¸ƒè°·é¸Ÿå“ˆå¸Œï¼‰
 **æ ¸å¿ƒæ€æƒ³**

å¤šä¸ª hash å‡½æ•°

ä¸€ä¸ª key æœ‰å¤šä¸ªâ€œåˆæ³•ä½ç½®â€

 **æ’å…¥è¿‡ç¨‹ï¼ˆåƒè¸¢äººï¼‰**

key æœ‰å¤šä¸ªå€™é€‰ slot

æœ‰ç©º â†’ æ’å…¥

éƒ½æ»¡ â†’ è¸¢èµ°ä¸€ä¸ªæ—§ key

è¢«è¸¢çš„ key æ¢åœ°æ–¹

å¯èƒ½å½¢æˆå¾ªç¯

ğŸ‘‰ å¾ªç¯äº†æ€ä¹ˆåŠï¼Ÿ

æ¢ hash seed

æˆ–æ‰©è¡¨é‡å»º

 **ç‰¹ç‚¹**

âœ… æŸ¥æ‰¾ / åˆ é™¤ï¼š

ä¸¥æ ¼ O(1)

âŒ æ’å…¥ï¼š

å¯èƒ½å¾ˆæ…¢

å®ç°å¤æ‚

æœ¬è´¨ï¼š

â€œä¸€ä¸ª key å¤šä¸ªå®¶ï¼ŒæŒ¤æ¥æŒ¤å»â€

# å…­ã€åŠ¨æ€å“ˆå¸Œï¼ˆDynamic Hashingï¼‰

ğŸ‘‰ ç›®æ ‡ï¼š

ä¸ç”¨æ•´ä½“é‡å»ºï¼Œä¹Ÿèƒ½æ‰©ç¼©å®¹

**Chained Hashingï¼ˆé“¾å¼å“ˆå¸Œï¼‰**

æ¯ä¸ª slot æ˜¯ä¸€ä¸ªé“¾è¡¨

å†²çª â†’ æŒ‚é“¾è¡¨

âœ… ç®€å•
âŒ é“¾è¡¨é•¿äº†ä¼šæ…¢
âŒ cache ä¸å‹å¥½

 **Extendible Hashingï¼ˆå¯æ‰©å±•å“ˆå¸Œï¼‰**

è¿™æ˜¯ æ•°æ®åº“è¯¾é‡ç‚¹

æ ¸å¿ƒæ€æƒ³ï¼š

åªæ‹†ä¸€ä¸ªæ¡¶ï¼Œä¸åŠ¨å…¶ä»–æ¡¶

å…³é”®æ¦‚å¿µ

Global Depthï¼šç›®å½•ç”¨å¤šå°‘ä½ hash

Local Depthï¼šæ¡¶è‡ªå·±ç”¨äº†å¤šå°‘ä½

æ¡¶æ»¡äº†æ€ä¹ˆåŠï¼Ÿ

å¦‚æœ local < globalï¼š

åªæ‹†æ¡¶

ç›®å½•ä¸å˜

å¦‚æœ local == globalï¼š

ç›®å½•ç¿»å€

global++

 ä¼˜ç‚¹ï¼š

ä¸éœ€è¦å…¨è¡¨é‡å»º

ç£ç›˜å‹å¥½
==ä¾‹å­==ï¼š


1.ä¾‹å­è®¾å®šï¼ˆéå¸¸é‡è¦ï¼‰

ä¸ºäº†è®©è¿‡ç¨‹æ¸…æ™°ï¼Œæˆ‘ä»¬å…ˆ**ç»Ÿä¸€è§„åˆ™**ï¼š

å“ˆå¸Œå‡½æ•°

å‡è®¾å“ˆå¸Œå‡½æ•°å·²ç»ç®—å¥½ï¼Œ**æˆ‘ä»¬åªçœ‹äºŒè¿›åˆ¶å“ˆå¸Œå€¼çš„â€œä½ä½â€**ï¼š

| Key | Hashï¼ˆäºŒè¿›åˆ¶ï¼Œä½ä½åœ¨å³ï¼‰ |
| --- | -------------- |
| A   | `000`          |
| B   | `001`          |
| C   | `010`          |
| D   | `011`          |
| E   | `100`          |
| F   | `101`          |

> å®é™… DBMS ç”¨ XXHash / MurmurHash
> è¯¾å ‚é‡Œä¸ºäº†è®²æ¸…æ¥šï¼Œ**ç›´æ¥ç»™ hash å€¼**

---

æ¡¶ï¼ˆBucketï¼‰å®¹é‡

* **æ¯ä¸ªæ¡¶æœ€å¤šæ”¾ 2 æ¡è®°å½•**
* è¶…è¿‡å°±è§¦å‘ **split**

---

2.åˆå§‹åŒ–çŠ¶æ€

åˆå§‹å‚æ•°

* **Global Depth = 1**
* ç›®å½•å¤§å° = `2^1 = 2`
* æ¯ä¸ªæ¡¶çš„ **Local Depth = 1**

### ç›®å½•ç»“æ„

åªçœ‹ hash çš„ **æœ€ä½ 1 ä½**

```c
Global Depth = 1

Directory
0 â”€â”€â–¶ Bucket 0 (LD=1)
1 â”€â”€â–¶ Bucket 1 (LD=1)
```

---

3.æ’å…¥è¿‡ç¨‹ï¼ˆæ ¸å¿ƒï¼ï¼‰

---

### ğŸ”¹ Step 1ï¼šæ’å…¥ Aï¼ˆ000ï¼‰

æœ€ä½ 1 ä½æ˜¯ `0`

```c
Bucket 0: [A]
Bucket 1: []
```

---

### ğŸ”¹ Step 2ï¼šæ’å…¥ Bï¼ˆ001ï¼‰

æœ€ä½ 1 ä½æ˜¯ `1`

```c
Bucket 0: [A]
Bucket 1: [B]
```

---

### ğŸ”¹ Step 3ï¼šæ’å…¥ Cï¼ˆ010ï¼‰

æœ€ä½ 1 ä½æ˜¯ `0`

```c
Bucket 0: [A, C]   â† æ»¡äº†
Bucket 1: [B]
```

âœ” è¿˜æ²¡æº¢å‡ºï¼ˆå®¹é‡=2ï¼‰

---

### ğŸ”¹ Step 4ï¼šæ’å…¥ Dï¼ˆ011ï¼‰

æœ€ä½ 1 ä½æ˜¯ `1`

```
Bucket 1: [B, D]   â† æ»¡äº†
```

---

### ğŸ”¹ Step 5ï¼šæ’å…¥ Eï¼ˆ100ï¼‰

æœ€ä½ 1 ä½æ˜¯ `0`
ğŸ‘‰ Bucket 0 è¦æº¢å‡ºäº†ï¼

```c
Bucket 0: [A, C, E] âŒ overflow
```

---

4.å…³é”®ï¼šæ¡¶åˆ†è£‚ï¼ˆSplitï¼‰

### å½“å‰çŠ¶æ€

* Bucket 0ï¼šLocal Depth = 1
* Global Depth = 1

 **è§„åˆ™**ï¼š

> å¦‚æœ `Local Depth == Global Depth`
> ğŸ‘‰ å¿…é¡» **æ‰©å±•ç›®å½•**

---

5.ç›®å½•æ‰©å±•ï¼ˆDirectory Doublingï¼‰

 Global Depth +1

```c
Global Depth = 2
Directory size = 4
```

 æ–°ç›®å½•ï¼ˆä½ 2 ä½ï¼‰

```c
00 â”€â”€â–¶ Bucket 0
01 â”€â”€â–¶ Bucket 1
10 â”€â”€â–¶ Bucket 0
11 â”€â”€â–¶ Bucket 1
```

> æ³¨æ„ï¼š
> **ç›®å½•ç¿»å€ï¼Œä½†æ¡¶è¿˜æ²¡å˜ï¼**

---

6.çœŸæ­£çš„æ¡¶åˆ†è£‚ï¼ˆåªæ‹†ä¸€ä¸ªæ¡¶ï¼‰

### è¢«æ‹†çš„æ˜¯ï¼šBucket 0

* åŸ Local Depth = 1
* æ–° Local Depth = 2
* åˆ†è£‚æˆï¼š

  * Bucket 00
  * Bucket 10

### é‡æ–°åˆ†é… Bucket 0 ä¸­çš„æ•°æ®

| Key | Hash | ä½ 2 ä½ | æ–°æ¡¶        |
| --- | ---- | ----- | --------- |
| A   | 000  | `00`  | Bucket 00 |
| C   | 010  | `10`  | Bucket 10 |
| E   | 100  | `00`  | Bucket 00 |

---

7.æ‹†åˆ†åçš„ç»“æ„ï¼ˆéå¸¸é‡è¦ï¼‰

```c
Global Depth = 2

Directory
00 â”€â”€â–¶ Bucket 00 (LD=2): [A, E]
01 â”€â”€â–¶ Bucket 1  (LD=1): [B, D]
10 â”€â”€â–¶ Bucket 10 (LD=2): [C]
11 â”€â”€â–¶ Bucket 1  (LD=1): [B, D]
```

### âš ï¸ å…³é”®è§‚å¯Ÿ

* **Bucket 1 è¢«ä¸¤ä¸ªç›®å½•é¡¹æŒ‡å‘**
* **Local Depth < Global Depth æ˜¯å…è®¸çš„**

---

8.ç»§ç»­æ’å…¥ Fï¼ˆ101ï¼‰

Hash = `101`
ä½ 2 ä½ = `01`

```
01 â”€â”€â–¶ Bucket 1
```

æ’å…¥åï¼š

```
Bucket 1: [B, D, F] âŒ overflow
```

---

9.å†æ¬¡åˆ†è£‚ï¼ˆè¿™æ¬¡ä¸æ‰©ç›®å½•ï¼ï¼‰

### Bucket 1 æƒ…å†µ

* Local Depth = 1
* Global Depth = 2

 `LD < GD`
ğŸ‘‰ **åªåˆ†æ¡¶ï¼Œä¸æ‰©ç›®å½•**

---

### æ‹† Bucket 1

* æ–° Local Depth = 2
* åˆ†è£‚æˆï¼š

  * Bucket 01
  * Bucket 11

### é‡æ–°åˆ†é…æ•°æ®

| Key | Hash | ä½ 2 ä½ | æ–°æ¡¶        |
| --- | ---- | ----- | --------- |
| B   | 001  | 01    | Bucket 01 |
| D   | 011  | 11    | Bucket 11 |
| F   | 101  | 01    | Bucket 01 |

---

10.æœ€ç»ˆç»“æ„ï¼ˆå®Œç¾çŠ¶æ€ï¼‰

```c
Global Depth = 2

00 â”€â”€â–¶ Bucket 00 (LD=2): [A, E]
01 â”€â”€â–¶ Bucket 01 (LD=2): [B, F]
10 â”€â”€â–¶ Bucket 10 (LD=2): [C]
11 â”€â”€â–¶ Bucket 11 (LD=2): [D]
```

---


---


**Linear Hashingï¼ˆçº¿æ€§å“ˆå¸Œï¼‰**
æ ¸å¿ƒæ€æƒ³ï¼š
æ…¢æ…¢æ‹†ï¼Œä¸ç€æ€¥

æœºåˆ¶
æœ‰ä¸€ä¸ª split pointer
ä¸ç®¡å“ªä¸ªæ¡¶æ»¡ï¼š
éƒ½æ‹† pointer æŒ‡å‘çš„æ¡¶
æ‹†å®Œ pointer++

ä¼˜ç‚¹
å¢é•¿æ˜¯ æ¸è¿›å¼
æ²¡æœ‰ç›®å½•ç¿»å€çš„æŠ–åŠ¨
 DBMS éå¸¸å–œæ¬¢å®ƒ

