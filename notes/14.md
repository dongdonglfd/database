## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å¹¶å‘æŽ§åˆ¶ï¼Ÿï¼ˆMotivationï¼‰

### 1ï¸âƒ£ Lost Updateï¼ˆä¸¢å¤±æ›´æ–°ï¼‰é—®é¢˜

**é—®é¢˜æœ¬è´¨ï¼š**

> ä¸¤ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰äº‹åŠ¡ **åŒæ—¶æ”¹åŒä¸€ä»½æ•°æ®**ï¼Œç»“æžœäº’ç›¸è¦†ç›–ï¼Œå¯¼è‡´æœ€ç»ˆç»“æžœæ˜¯é”™çš„ã€‚

### ä¸¾ä¸ªæœ€ç›´è§‚çš„ä¾‹å­ï¼ˆé“¶è¡Œè´¦æˆ·ï¼‰

Andy è´¦æˆ·é‡Œæœ‰ **100 å—é’±**
çŽ°åœ¨åŒæ—¶å‘ç”Ÿä¸¤ä»¶äº‹ï¼š

* äº‹åŠ¡ T1ï¼šç»™æ¼”å”±ä¼šä¸»åŠžæ–¹ A è½¬ 25
* äº‹åŠ¡ T2ï¼šç»™æ¼”å”±ä¼šä¸»åŠžæ–¹ B è½¬ 25

å¦‚æžœ **æ²¡æœ‰å¹¶å‘æŽ§åˆ¶**ï¼Œå¯èƒ½å‘ç”Ÿï¼š

1. T1 è¯»åˆ°ä½™é¢ = 100
2. T2 ä¹Ÿè¯»åˆ°ä½™é¢ = 100
3. T1 å†™å›ž 75
4. T2 å†™å›ž 75

ðŸ‘‰ **æœ€ç»ˆä½™é¢ = 75**
ðŸ‘‰ **ä½†å®žé™…ä¸Šæ‰£äº†ä¸¤æ¬¡é’±ï¼Œåº”è¯¥æ˜¯ 50**

è¿™å°±å«ï¼š**ä¸¢å¤±æ›´æ–°ï¼ˆLost Updateï¼‰**

---

### 2ï¸âƒ£ Durabilityï¼ˆæŒä¹…æ€§ï¼‰é—®é¢˜

**é—®é¢˜æœ¬è´¨ï¼š**

> å¦‚æžœç³»ç»Ÿçªç„¶æ–­ç”µ / å´©æºƒï¼Œå·²ç»â€œæˆåŠŸâ€çš„äº‹åŠ¡ï¼Œç»“æžœè¿˜åœ¨ä¸åœ¨ï¼Ÿ

æ¯”å¦‚ï¼š

* è½¬è´¦æˆåŠŸåŽ
* ç³»ç»Ÿçªç„¶æ–­ç”µ
* é‡å¯åŽå‘çŽ°é’±æ²¡äº† or é‡å¤æ‰£äº†

ðŸ‘‰ **è¿™æ˜¯å®Œå…¨ä¸èƒ½æŽ¥å—çš„**

---

## äºŒã€ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿï¼ˆTransactionsï¼‰

### å®˜æ–¹å®šä¹‰ï¼ˆç¿»è¯‘æˆäººè¯ï¼‰

> **äº‹åŠ¡ = ä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆå…¨åšå®Œï¼Œè¦ä¹ˆä¸€ä»¶éƒ½åˆ«å‘ç”Ÿ**

### é“¶è¡Œè½¬è´¦äº‹åŠ¡ï¼ˆç»å…¸ä¾‹å­ï¼‰

ç»™ Andy æ‰£ 25ï¼š

1. è¯»ä½™é¢
2. åˆ¤æ–­ä½™é¢æ˜¯å¦ â‰¥ 25
3. æ‰£é’±
4. å†™å›žæ•°æ®åº“

ðŸ‘‰ **ä¸èƒ½åªåšç¬¬ 1ã€2ã€3 æ­¥å°±åœ**
ðŸ‘‰ **è¦ä¹ˆ 4 æ­¥å…¨æˆåŠŸ**
ðŸ‘‰ **è¦ä¹ˆæ•°æ®åº“å½“è¿™ä»¶äº‹ä»Žæ²¡å‘ç”Ÿ**

è¿™å°±æ˜¯ï¼š**åŽŸå­æ€§ï¼ˆAtomicityï¼‰**

---

## ä¸‰ã€æœ€è ¢ä½†ç»å¯¹æ­£ç¡®çš„æ–¹æ¡ˆï¼ˆStrawman Systemï¼‰

### æƒ³è±¡ä¸€ä¸ªâ€œå¹¼å„¿å›­çº§æ•°æ®åº“â€

è§„åˆ™åªæœ‰ä¸€å¥ï¼š

> **ä¸€æ¬¡åªèƒ½è·‘ä¸€ä¸ªäº‹åŠ¡**

å…·ä½“åšæ³•ï¼š

1. å¼€å§‹äº‹åŠ¡å‰
2. **æŠŠæ•´ä¸ªæ•°æ®åº“å¤åˆ¶ä¸€ä»½**
3. æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨å‰¯æœ¬ä¸Š
4. æˆåŠŸ â†’ æ›¿æ¢åŽŸæ•°æ®åº“
5. å¤±è´¥ â†’ æ‰”æŽ‰å‰¯æœ¬

è¿™ä¸ªæ–¹æ¡ˆä¹Ÿå«ï¼š**Shadow Pagingï¼ˆå½±å­åˆ†é¡µï¼‰**

---

### è¿™ä¸ªæ–¹æ¡ˆæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

#### âœ… ä¼˜ç‚¹

* æ°¸è¿œä¸ä¼šé”™
* æ°¸è¿œä¸ä¼šå¹¶å‘å†²çª
* å´©æºƒæ¢å¤è¶…çº§ç®€å•

#### âŒ ç¼ºç‚¹
* **å®Œå…¨æ²¡æœ‰å¹¶å‘**
* **æ¯ä¸ªäº‹åŠ¡éƒ½å¤åˆ¶æ•´ä¸ªæ•°æ®åº“**
* çŽ°ä»£ CPU å¤šæ ¸ã€ç£ç›˜å¹¶è¡Œå…¨éƒ¨æµªè´¹

ðŸ‘‰ **çŽ°å®žæ•°æ®åº“ç»å¯¹ä¸ä¼šè¿™ä¹ˆå¹²**

---

## å››ã€çœŸæ­£çš„ç›®æ ‡ï¼šåˆå¿«åˆå¯¹

æ•°æ®åº“çœŸæ­£æƒ³è¦çš„æ˜¯ï¼š

* **å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œ**
* **ç»“æžœçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªä¸ªé¡ºåºæ‰§è¡Œ**
* **è°éƒ½ä¸åƒäºï¼Œä¸é¥¿æ­»ï¼ˆå…¬å¹³ï¼‰**

è¿™å°±å¼•å‡ºäº†ä¸€ä¸ªæ ¸å¿ƒçŸ›ç›¾ï¼š

> å¹¶å‘è¶Šå¤š â†’ è¶Šå¿«
> æŽ§åˆ¶è¶Šä¸¥ â†’ è¶Šå®‰å…¨

ðŸ‘‰ **å¹¶å‘æŽ§åˆ¶ = åœ¨â€œå¿«â€å’Œâ€œå¯¹â€ä¹‹é—´æ‰¾å¹³è¡¡**

---

## äº”ã€ä»€ä¹ˆæ˜¯â€œä¸å…è®¸çš„é”™è¯¯â€ï¼Ÿ

### å¹¶å‘æ‰§è¡Œä¼šå¯¼è‡´ä¸¤ç±»é—®é¢˜ï¼š

#### âœ… Temporary Inconsistencyï¼ˆä¸´æ—¶ä¸ä¸€è‡´ï¼‰

* ä¸­é—´è¿‡ç¨‹ä¹±ä¸€ç‚¹
* åªè¦æœ€ç»ˆç»“æžœå¯¹
* **å¯ä»¥æŽ¥å—**

#### âŒ Permanent Inconsistencyï¼ˆæ°¸ä¹…ä¸ä¸€è‡´ï¼‰

* æ•°æ®æœ€ç»ˆçŠ¶æ€æ˜¯é”™çš„
* è´¦å¯¹ä¸ä¸Š
* **ç»å¯¹ä¸å…è®¸**

ðŸ‘‰ **å¹¶å‘æŽ§åˆ¶çš„ç›®æ ‡ï¼šæœç»æ°¸ä¹…ä¸ä¸€è‡´**

---

## å…­ã€æ•°æ®åº“åˆ°åº•å…³å¿ƒä»€ä¹ˆï¼Ÿ

æ•°æ®åº“ **åªå…³å¿ƒ**ï¼š

* è° **è¯»** äº†ä»€ä¹ˆ
* è° **å†™** äº†ä»€ä¹ˆ
* é¡ºåºæ˜¯æ€Žæ ·çš„

æ•°æ®åº“ **ä¸å…³å¿ƒ**ï¼š

* ä½ å‘æ²¡å‘é‚®ä»¶
* ä½ è°ƒæ²¡è°ƒå¤–éƒ¨ API

> å¤–éƒ¨ä¸–ç•Œçš„äº‹æƒ…ï¼Œä¸€æ—¦å‘ç”Ÿï¼ŒDB å›žæ»šä¸äº†

---

## ä¸ƒã€å½¢å¼åŒ–å®šä¹‰ï¼ˆDefinitionsï¼‰

### 1ï¸âƒ£ æ•°æ®å¯¹è±¡ï¼ˆObjectï¼‰

æ•°æ®åº“æŠ½è±¡æˆä¸€å †å¯¹è±¡ï¼š

* Aã€Bã€Câ€¦
* å¯ä»¥æ˜¯ï¼š

  * è¡Œ
  * é¡µ
  * è¡¨
  * ç´¢å¼•
  * æ•´ä¸ªæ•°æ®åº“

**æ³¨æ„ï¼š**

> å¹¶å‘æŽ§åˆ¶ç®—æ³•å‡è®¾æ‰€æœ‰å¯¹è±¡æ˜¯â€œåŒä¸€å±‚çº§â€çš„

---

### 2ï¸âƒ£ äº‹åŠ¡ï¼ˆTransactionï¼‰

ä»Žæ•°æ®åº“è§†è§’ï¼š

> äº‹åŠ¡ = ä¸€ä¸² **è¯»ï¼ˆRï¼‰** å’Œ **å†™ï¼ˆWï¼‰** æ“ä½œ

æ¯”å¦‚ï¼š

```
R(A)
W(A)
R(B)
W(B)
```

---

### 3ï¸âƒ£ äº‹åŠ¡è¾¹ç•Œ

SQL é‡Œï¼š

```sql
BEGIN;
...
COMMIT;  -- æˆ– ABORT;
```

* **COMMIT**ï¼šæ”¹åŠ¨æ°¸ä¹…ç”Ÿæ•ˆ
* **ABORT**ï¼šæ‰€æœ‰æ”¹åŠ¨æ’¤é”€ï¼Œå½“æ²¡å‘ç”Ÿè¿‡

Abort å¯ä»¥ï¼š

* è‡ªå·±è§¦å‘ï¼ˆä½™é¢ä¸è¶³ï¼‰
* DBMS å¼ºåˆ¶ï¼ˆå†²çªã€æ­»é”ã€å´©æºƒï¼‰

---

## å…«ã€ACIDï¼šæ•°æ®åº“çš„å››å¤§é‡‘åˆš

### A â€” Atomicityï¼ˆåŽŸå­æ€§ï¼‰

è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš

---

### C â€” Consistencyï¼ˆä¸€è‡´æ€§ï¼‰

**ä»€ä¹ˆæ„æ€ï¼Ÿ**

* æ•°æ®æ»¡è¶³æ‰€æœ‰çº¦æŸ
* ä¸»é”®ä¸é‡å¤
* å¤–é”®æœ‰æ•ˆ
* CHECK æ¡ä»¶æˆç«‹

ðŸ‘‰ æ¯ä¸ªäº‹åŠ¡è‡ªå·±è¦â€œå®ˆæ³•â€
ðŸ‘‰ DB è´Ÿè´£æ‰§è¡Œæ³•å¾‹

---

### I â€” Isolationï¼ˆéš”ç¦»æ€§ï¼‰

> **äº‹åŠ¡æ„Ÿè§‰è‡ªå·±æ˜¯ç³»ç»Ÿé‡Œå”¯ä¸€çš„äº‹åŠ¡**

å³ï¼š

* çœ‹ä¸åˆ°åˆ«äººçš„ä¸­é—´çŠ¶æ€
* å¹¶å‘æ‰§è¡Œçš„ç»“æžœ
* **ç­‰ä»·äºŽæŸç§é¡ºåºæ‰§è¡Œ**

âš ï¸ æ³¨æ„ï¼š

* å¹¶ä¸è¦æ±‚â€œçœŸçš„é¡ºåºæ‰§è¡Œâ€
* **åªè¦æ±‚ç»“æžœåƒé¡ºåºæ‰§è¡Œ**

---

### D â€” Durabilityï¼ˆæŒä¹…æ€§ï¼‰

> äº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œç»“æžœæ°¸ä¸ä¸¢å¤±

å³ä½¿ï¼š

* æ–­ç”µ
* å´©æºƒ
* é‡å¯

---

## ä¹ã€Atomicity çš„ä¸¤ç§å®žçŽ°æ–¹å¼

### æ–¹æ³• 1ï¸âƒ£ï¼šLoggingï¼ˆæ—¥å¿—ï¼‰âœ… ä¸»æµæ–¹æ¡ˆ

æ ¸å¿ƒæ€æƒ³ï¼š

> **å…ˆè®°è´¦ï¼Œå†å¹²æ´»**

æ•°æ®åº“åšçš„äº‹ï¼š

* æ¯æ¬¡å†™æ•°æ®å‰
* æŠŠâ€œæ€Žä¹ˆæ”¹çš„â€å†™è¿›æ—¥å¿—
* å´©æºƒåŽï¼š

  * å·²æäº¤ â†’ é‡åš
  * æœªæäº¤ â†’ å›žæ»š

ðŸ‘‰ **å‡ ä¹Žæ‰€æœ‰çŽ°ä»£æ•°æ®åº“éƒ½ç”¨è¿™ä¸ª**

---

### æ–¹æ³• 2ï¸âƒ£ï¼šShadow Pagingï¼ˆå½±å­åˆ†é¡µï¼‰

* ä¿®æ”¹åªåœ¨å‰¯æœ¬
* æäº¤æ‰æ›¿æ¢
* å´©æºƒç›´æŽ¥ä¸¢å¼ƒå‰¯æœ¬

ä¼˜ç‚¹ï¼š

* ä¸éœ€è¦æ—¥å¿—
* æ¢å¤æžå¿«

ç¼ºç‚¹ï¼š

* è¿è¡Œæ—¶å¤ªæ…¢
* ä¸é€‚åˆå¹¶å‘

ðŸ‘‰ **å‡ ä¹Žä¸ç”¨**

---

## åã€Isolationï¼šå¹¶å‘æŽ§åˆ¶çš„æ ¸å¿ƒ

### æ•°æ®åº“æƒ³åšåˆ°çš„å‡è±¡

> è™½ç„¶ T1ã€T2ã€T3 åŒæ—¶è·‘
> ä½†ç»“æžœçœ‹èµ·æ¥åƒï¼š
>
> * å…ˆ T1 å† T2 å† T3
>   æˆ–
> * å…ˆ T2 å† T1 å† T3
>   â€¦

è¿™ç§â€œçœ‹èµ·æ¥åƒé¡ºåºæ‰§è¡Œâ€çš„è°ƒåº¦ï¼Œå«ï¼š

> **Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰**

---

## åä¸€ã€å¹¶å‘æŽ§åˆ¶åè®®ï¼ˆConcurrency Controlï¼‰

### ä¸¤å¤§æµæ´¾

#### 1ï¸âƒ£ æ‚²è§‚ï¼ˆPessimisticï¼‰

> æˆ‘é»˜è®¤ä½ ä»¬ä¼šå†²çª
> æ‰€ä»¥å…ˆä¸Šé”å†è¯´

å…¸åž‹ï¼š

* ä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰

---

#### 2ï¸âƒ£ ä¹è§‚ï¼ˆOptimisticï¼‰

> æˆ‘èµŒä½ ä»¬ä¸ä¼šå†²çª
> çœŸå†²çªäº†å†å›žæ»š

å…¸åž‹ï¼š

* OCC
* MVCCï¼ˆéƒ¨åˆ†æ€æƒ³ï¼‰

---

## åäºŒã€æ‰§è¡Œè°ƒåº¦ï¼ˆScheduleï¼‰

### ä»€ä¹ˆæ˜¯ Scheduleï¼Ÿ

> **DBMS å®žé™…æ‰§è¡Œæ“ä½œçš„é¡ºåº**

---

### ä¸‰ä¸ªé‡è¦æ¦‚å¿µ

#### 1ï¸âƒ£ Serial Scheduleï¼ˆä¸²è¡Œï¼‰

* å®Œå…¨ä¸äº¤å‰
* ä¸€ä¸ªäº‹åŠ¡è·‘å®Œï¼Œä¸‹ä¸€ä¸ªæ‰å¼€å§‹

#### 2ï¸âƒ£ Equivalent Scheduleï¼ˆç­‰ä»·ï¼‰

* æœ€ç»ˆæ•°æ®åº“çŠ¶æ€ä¸€æ ·

#### 3ï¸âƒ£ Serializable Scheduleï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰

* ç­‰ä»·äºŽæŸä¸ªä¸²è¡Œæ‰§è¡Œ
* **è¿™å°±æ˜¯ DBMS çš„ç›®æ ‡**

---

## åä¸‰ã€ä»€ä¹ˆæ˜¯å†²çªï¼ˆConflictï¼‰ï¼Ÿ

ä¸¤ä¸ªæ“ä½œå†²çªï¼Œå¿…é¡»æ»¡è¶³ï¼š

1. æ¥è‡ª **ä¸åŒäº‹åŠ¡**
2. æ“ä½œ **åŒä¸€ä¸ªå¯¹è±¡**
3. **è‡³å°‘ä¸€ä¸ªæ˜¯å†™**

---

### ä¸‰ç§ç»å…¸å†²çª

#### 1ï¸âƒ£ Readâ€“Writeï¼ˆä¸å¯é‡å¤è¯»ï¼‰

* å‰åŽä¸¤æ¬¡è¯»ï¼Œå€¼ä¸ä¸€æ ·

#### 2ï¸âƒ£ Writeâ€“Readï¼ˆè„è¯»ï¼‰

* è¯»åˆ°äº†åˆ«äººè¿˜æ²¡æäº¤çš„å†™

#### 3ï¸âƒ£ Writeâ€“Writeï¼ˆä¸¢å¤±æ›´æ–°ï¼‰

* äº’ç›¸è¦†ç›–

---

## åå››ã€å¯ä¸²è¡ŒåŒ–çš„ä¸¤ç§å®šä¹‰

### 1ï¸âƒ£ å†²çªå¯ä¸²è¡ŒåŒ–ï¼ˆConflict Serializableï¼‰âœ… å®žé™…ä½¿ç”¨

* çœ‹ **å†²çªé¡ºåº**
* èƒ½å¦é€šè¿‡äº¤æ¢ä¸å†²çªæ“ä½œ
* å˜æˆæŸä¸ªä¸²è¡Œé¡ºåº

---

### 2ï¸âƒ£ è§†å›¾å¯ä¸²è¡ŒåŒ–ï¼ˆView Serializableï¼‰

* å…è®¸â€œç›²å†™â€
* ç†è®ºä¸Šæ›´å®½æ¾
* **å®žçŽ°æˆæœ¬æžé«˜**

ðŸ‘‰ **å®žé™…æ•°æ®åº“ä¸ç”¨**

---

## åäº”ã€ä¾èµ–å›¾ï¼ˆDependency Graphï¼‰

### æ€Žä¹ˆåˆ¤æ–­å†²çªå¯ä¸²è¡ŒåŒ–ï¼Ÿ

ç”»å›¾ï¼

* æ¯ä¸ªäº‹åŠ¡æ˜¯ä¸€ä¸ªç‚¹
* å¦‚æžœï¼š

  * Ti çš„æ“ä½œ
  * åœ¨ Tj å‰
  * ä¸”å†²çª
* å°±ç”»ä¸€æ¡ï¼šTi â†’ Tj

### ç»“è®ºï¼š

> **å›¾ä¸­æ— çŽ¯ â†’ å¯ä¸²è¡ŒåŒ–**
> **æœ‰çŽ¯ â†’ ä¸å¯ä¸²è¡ŒåŒ–**

---

## åå…­ã€æ‰€æœ‰è°ƒåº¦çš„â€œå®‡å®™å…³ç³»â€

```
ä¸²è¡Œè°ƒåº¦
  âŠ‚ å†²çªå¯ä¸²è¡ŒåŒ–
      âŠ‚ è§†å›¾å¯ä¸²è¡ŒåŒ–
          âŠ‚ æ‰€æœ‰è°ƒåº¦
```

---

## åä¸ƒã€Durabilityï¼ˆæŒä¹…æ€§ï¼‰

ä¸€å¥è¯æ€»ç»“ï¼š

> **æäº¤è¿‡çš„äº‹åŠ¡ï¼Œè°ä¹Ÿåˆ«æƒ³æŠ¹æŽ‰**

å®žçŽ°æ–¹å¼ï¼š

* Logging
* Shadow Paging

å‰æï¼š

* æ—¥å¿— / æ•°æ®å†™å…¥ **éžæ˜“å¤±å­˜å‚¨ï¼ˆç£ç›˜ã€NVMï¼‰**

---

## ä¸€å¥è¯æ€»ç»“æ•´è®²

> **å¹¶å‘æŽ§åˆ¶å°±æ˜¯ï¼š
> åœ¨å¤šäººåŒæ—¶æ“ä½œæ•°æ®åº“æ—¶ï¼Œ
> è®©ç»“æžœçœ‹èµ·æ¥åƒä¸€ä¸ªä¸ªè€è€å®žå®žæŽ’é˜Ÿæ‰§è¡Œï¼Œ
> è€Œä¸”ç³»ç»Ÿè¿˜èƒ½è·‘å¾—é£žå¿«ã€‚**


