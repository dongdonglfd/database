>DBImpl

>sequence number

---

# ä¸€ã€DBImpl çš„çœŸå®èº«ä»½ï¼ˆå†å‡çº§ä¸€å±‚ç†è§£ï¼‰

ä¸€å¥è¯å‡çº§ç‰ˆï¼š

> **DBImpl = çŠ¶æ€æœº + å†™å…¥è°ƒåº¦å™¨ + ç‰ˆæœ¬åˆ‡æ¢å™¨ + åå°ä»»åŠ¡åè°ƒè€…**

å®ƒä¸æ˜¯ç®€å•çš„â€œæ•°æ®åº“ç±»â€ï¼Œè€Œæ˜¯ï¼š

* æŒæœ‰ **æ‰€æœ‰å…¨å±€çŠ¶æ€**
* æ§åˆ¶ **å†™å…¥é¡ºåº**
* å†³å®š **å“ªä¸ª Version å¯¹å¤–å¯è§**
* åè°ƒ **å‰å°è¯·æ±‚ & åå° compaction**

---

# äºŒã€DBImpl æŒæœ‰å“ªäº›â€œçŠ¶æ€â€ï¼ˆStateï¼‰

ä½ å¯ä»¥æŠŠ DBImpl çœ‹æˆä¸€ä¸ª**å·¨å¤§ struct çŠ¶æ€æœº**ã€‚

## 1ï¸âƒ£ å†™è·¯å¾„çŠ¶æ€

```cpp
MemTable* mem_;
MemTable* imm_;
bool has_imm_;
```

**ä¸å˜å¼ï¼ˆInvariantï¼‰**ï¼š

* ä»»ä½•æ—¶åˆ»ï¼š

  * `mem_`ï¼šå¯å†™
  * `imm_`ï¼šåªè¯»ï¼ˆæœ€å¤š 1 ä¸ªï¼‰
* `mem_` æ»¡ â†’ è½¬æˆ `imm_`

---

## 2ï¸âƒ£ æ—¥å¿—çŠ¶æ€ï¼ˆWALï¼‰

```cpp
WritableFile* logfile_;
uint64_t logfile_number_;
Wal* log_;
```

ä¿è¯ï¼š

> **æ‰€æœ‰å·²è¿”å›ç»™ç”¨æˆ·çš„å†™æ“ä½œï¼Œä¸€å®šå·²è¿› WAL**

---

## 3ï¸âƒ£ ç‰ˆæœ¬çŠ¶æ€ï¼ˆSSTable çš„çœŸç›¸ï¼‰

```cpp
VersionSet* versions_;
```

VersionSet å†…éƒ¨ç»´æŠ¤ï¼š

```
current_ â†’ Version
            â”œâ”€â”€ Level 0: file list
            â”œâ”€â”€ Level 1: file list
            â””â”€â”€ ...
```

ğŸ“Œ **è¯»è¯·æ±‚åªçœ‹ current_**

---

## 4ï¸âƒ£ å†™å¹¶å‘çŠ¶æ€ï¼ˆæå…¶å…³é”®ï¼‰

```cpp
std::deque<Writer*> writers_;
```

Writer æœ¬è´¨æ˜¯ï¼š

```cpp
struct Writer {
  WriteBatch* batch;
  Status status;
  bool done;
  CondVar cv;
};
```

ğŸ‘‰ **è¿™æ˜¯ LevelDB æ”¯æŒå¤šçº¿ç¨‹å†™çš„æ ¸å¿ƒ**

---

# ä¸‰ã€ä»â€œç”¨æˆ·ä¸€è¡Œ Putâ€å¼€å§‹ï¼Œå®Œæ•´æ‰§è¡Œé“¾

æˆ‘ä»¬èµ°ä¸€æ¡æœ€çœŸå®çš„è·¯å¾„ã€‚

---

## Step 0ï¼šç”¨æˆ·è°ƒç”¨

```cpp
db->Put(options, "k1", "v1");
```

---

## Step 1ï¼šDBImpl::Put

```cpp
WriteBatch batch;
batch.Put(key, value);
return Write(options, &batch);
```

ğŸ“Œ Put/Delete éƒ½åªæ˜¯ç³–è¡£

---

## Step 2ï¼šDBImpl::Writeï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰

è¿™æ˜¯ LevelDB æœ€å¤æ‚çš„å‡½æ•°ä¹‹ä¸€ï¼Œæˆ‘ä»¬æ‹†æˆ **10 ä¸ªé˜¶æ®µ**ã€‚

---

### ğŸ”’ Phase 1ï¼šåŠ é” & å…¥é˜Ÿ

```cpp
mutex_.Lock();

Writer w;
writers_.push_back(&w);
```

æ­¤æ—¶ï¼š

```
writers_ = [ w1, w2, w3 ... ]
```

---

### â³ Phase 2ï¼šæ’é˜Ÿç­‰å¾…

```cpp
while (!w.done && &w != writers_.front()) {
  w.cv.Wait();
}
```

ğŸ“Œ åªæœ‰ **é˜Ÿé¦– writer** æ‰èƒ½æ‰§è¡Œå†™

ğŸ‘‰ ä¿è¯ WAL é¡ºåº

---

### ğŸ“¦ Phase 3ï¼šBatch åˆå¹¶ï¼ˆGroup Commitï¼‰

```cpp
WriteBatch* batch = BuildBatchGroup(&last_writer);
```

å‡è®¾ï¼š

```
w1: Put(a)
w2: Put(b)
w3: Put(c)
```

åˆå¹¶åï¼š

```
batch = { a, b, c }
```

ğŸ”¥ æ€§èƒ½å…³é”®ç‚¹ï¼š
**3 æ¬¡å†™ â†’ 1 æ¬¡ WAL IO**

---

### ğŸ§  Phase 4ï¼šåˆ†é… sequence number

```cpp
SequenceNumber start = last_sequence_ + 1;
last_sequence_ += batch->Count();
```

ç°åœ¨ï¼š

```
a â†’ seq=100
b â†’ seq=101
c â†’ seq=102
```

---

### ğŸ“ Phase 5ï¼šå†™ WALï¼ˆæœ€å…³é”®çš„å®‰å…¨ç‚¹ï¼‰

```cpp
log_->AddRecord(batch->Contents());
```

âš ï¸ **è¿™ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªå†™å¤±è´¥**

---

### ğŸ§± Phase 6ï¼šå†™ MemTable

```cpp
InsertInto(batch, mem_);
```

å†™å…¥å½¢å¼ï¼š

```
InternalKey = (user_key, seq, type)
```

---

### ğŸ” Phase 7ï¼šæ ‡è®° writer å®Œæˆ

```cpp
for (w in writers_[0..last]) {
  w->done = true;
  w->cv.Signal();
}
writers_.pop_front();
```

---

### ğŸšª Phase 8ï¼šè§£é”

```cpp
mutex_.Unlock();
```

---

## Step 3ï¼šMemTable æ»¡äº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

### è§¦å‘æ¡ä»¶ï¼š

```cpp
mem_->ApproximateMemoryUsage() > write_buffer_size
```

---

### æ“ä½œæµç¨‹ï¼š

```cpp
imm_ = mem_;
mem_ = new MemTable();
has_imm_ = true;
```

ç„¶åï¼š

```cpp
MaybeScheduleCompaction();
```

---

## Step 4ï¼šåå°çº¿ç¨‹ flush MemTable

```cpp
CompactMemTable();
```

---

## Step 5ï¼šç”Ÿæˆ Level-0 SSTable

```cpp
WriteLevel0Table(imm_, &edit);
```

ç”Ÿæˆï¼š

```
000003.sst
```

---

## Step 6ï¼šVersionEdit è®°å½•å˜æ›´

```cpp
edit.AddFile(0, file_number, file_size);
```

---

## Step 7ï¼šåˆ‡æ¢ç‰ˆæœ¬ï¼ˆåŸå­ï¼‰

```cpp
versions_->LogAndApply(&edit);
```

ğŸ”¥ **è¿™ä¸€æ­¥æ˜¯â€œæ•°æ®åº“ä¸–ç•Œçº¿åˆ‡æ¢â€**

æ—§ Version â†’ ä¸å†å¯¹æ–°è¯»è¯·æ±‚å¯è§
æ–° Version â†’ æˆä¸º current

---

## Step 8ï¼šé‡Šæ”¾ imm_

```cpp
delete imm_;
imm_ = nullptr;
has_imm_ = false;
```

---

# å››ã€è¯»è·¯å¾„ DBImpl::Getï¼ˆæ·±æŒ–ï¼‰

```cpp
Status DBImpl::Get(...) {
  mutex_.Lock();

  MemTable* mem = mem_;
  MemTable* imm = imm_;
  Version* current = versions_->current();

  mutex_.Unlock();
}
```

ğŸ“Œ **å…³é”®è®¾è®¡**ï¼š
**å¾ˆå¿«é‡Šæ”¾é”**

---

### æŸ¥è¯¢é¡ºåºï¼ˆä¸å¯ä¹±ï¼‰

```
mem_ â†’ imm_ â†’ SSTable
```

ä¸ºä»€ä¹ˆï¼Ÿ

* mem_ï¼šæœ€æ–°
* imm_ï¼šåˆšå†»ç»“
* SSTableï¼šå†å²

---

### SSTable æŸ¥æ‰¾

```cpp
current->Get(...)
```

* åˆ©ç”¨æ–‡ä»¶ key range
* Bloom Filter
* TableCache

---

# äº”ã€Compaction æ˜¯æ€ä¹ˆè¢« DBImpl ç®¡çš„ï¼Ÿ

DBImpl ä¸å¹²æ´»ï¼Œåªè°ƒåº¦ã€‚

### è§¦å‘ç‚¹ï¼š

* L0 æ–‡ä»¶è¿‡å¤š
* æŸå±‚å¤§å°è¶…é™
* æ‰‹åŠ¨è§¦å‘

---

### åå°çº¿ç¨‹å…¥å£ï¼š

```cpp
DBImpl::BGWork â†’ BackgroundCall â†’ BackgroundCompaction
```

---

### çœŸæ­£å¹²æ´»çš„å‡½æ•°ï¼š

```cpp
DoCompactionWork()
```

å®ƒä¼šï¼š

* é€‰æ–‡ä»¶
* merge iterator
* å†™æ–° SSTable
* äº§ç”Ÿ VersionEdit
* LogAndApply

---

# å…­ã€DBImpl æœ€ç‰›çš„ä¸‰ä¸ªè®¾è®¡ç‚¹

### ğŸ¥‡ 1ï¸âƒ£ Version åŸå­åˆ‡æ¢

* æ²¡æœ‰â€œä¿®æ”¹ Versionâ€
* åªæœ‰â€œåˆ›å»ºæ–° Versionâ€
* æŒ‡é’ˆåˆ‡æ¢

ğŸ‘‰ **æ— é”è¯»**

---

### ğŸ¥ˆ 2ï¸âƒ£ Writer é˜Ÿåˆ— + Batch åˆå¹¶

* ç®€å•
* é«˜æ•ˆ
* ä¸é¥¿æ­»

---

### ğŸ¥‰ 3ï¸âƒ£ å‰å°è½»é”ï¼Œåå°é‡æ´»

* Get å‡ ä¹ä¸é˜»å¡
* Compaction å…¨åœ¨åå°

---



---

# ä¸€ã€å…ˆç”¨ä¸€å¥æœ€â€œåœŸâ€çš„è¯è¯´æ¸…æ¥š

> **sequence number å°±æ˜¯ LevelDB ç»™â€œæ¯ä¸€æ¬¡å†™æ“ä½œâ€å‘çš„ä¸€ä¸ªâ€œæ’å·â€**

å°±åƒï¼š

* é“¶è¡Œå–å·
* å¤–å–è®¢å•å·
* æ—¶é—´çº¿é‡Œçš„ç¬¬å‡ æ¡æ¶ˆæ¯

ğŸ‘‰ **å·å¤§çš„ï¼Œä¸€å®šæ¯”å·å°çš„æ–°**

---

# äºŒã€ä¸ºä»€ä¹ˆä¸€å®šè¦â€œæ’å·â€ï¼Ÿ

ä½ æƒ³è±¡ä¸€ä¸ªæœ€ç®€å•çš„é—®é¢˜ğŸ‘‡

### é—®é¢˜ï¼š

åŒä¸€ä¸ª key `"a"`ï¼Œä½ å†™äº†å¾ˆå¤šæ¬¡ï¼š

```text
Put("a", "1")
Put("a", "2")
Delete("a")
Put("a", "3")
```

ä½ é—®æ•°æ®åº“ï¼š

> **ç°åœ¨ a æ˜¯å¤šå°‘ï¼Ÿ**

ä½ æ˜¯é ä»€ä¹ˆåˆ¤æ–­çš„ï¼Ÿ

âŒ é ç£ç›˜æ–‡ä»¶åå­—ï¼Ÿ
âŒ é å†™åœ¨å“ªä¸ª SSTableï¼Ÿ
âŒ é  MemTable / SSTableï¼Ÿ

éƒ½ä¸é è°±ã€‚

ğŸ‘‰ **å”¯ä¸€é è°±çš„å°±æ˜¯ï¼šè°æœ€åå†™çš„**

è€Œ sequence number å°±æ˜¯ **â€œæœ€åå†™çš„â€ çš„è¯æ˜**ã€‚

---

# ä¸‰ã€LevelDB æ˜¯æ€ä¹ˆç»™â€œæ’å·â€çš„ï¼Ÿ

### è§„åˆ™éå¸¸ç®€å•ï¼ˆä½†æå…¶é‡è¦ï¼‰

1. **æ¯ä¸€ä¸ª Put / Delete éƒ½ä¼šæ‹¿åˆ°ä¸€ä¸ªæ–°çš„åºå·**
2. **åºå·å…¨å±€é€’å¢**
3. **ä¸ä¼šé‡å¤**

æ¯”å¦‚ï¼š

| æ“ä½œ        | sequence number |
| --------- | --------------- |
| Put(a,1)  | 1               |
| Put(b,2)  | 2               |
| Put(a,3)  | 3               |
| Delete(a) | 4               |

---

# å››ã€çœŸæ­£éœ‡æ’¼çš„ä¸€ç‚¹ï¼šLevelDB ä¸ä¼šâ€œè¦†ç›–æ—§å€¼â€

å¾ˆå¤šäººç¬¬ä¸€ååº”æ˜¯é”™çš„ï¼š

> Put(a,2) ä¼šæŠŠ a=1 è¦†ç›–æ‰

âŒ **LevelDB ä»æ¥ä¸è¦†ç›–ï¼**

å®ƒå®é™…å­˜çš„æ˜¯ï¼š

```
a@1 â†’ 1
a@3 â†’ 3
a@4 â†’ DELETE
```

è¿™å°±æ˜¯ **å¤šç‰ˆæœ¬**ã€‚

---

# äº”ã€ç”¨â€œè´¦æœ¬â€æ¥ç†è§£ï¼ˆéå¸¸ç›´è§‚ï¼‰

æŠŠ LevelDB æƒ³æˆä¸€æœ¬è´¦æœ¬ï¼š

```
[ç¬¬ 1 è¡Œ]  a = 1
[ç¬¬ 3 è¡Œ]  a = 3
[ç¬¬ 4 è¡Œ]  åˆ é™¤ a
```

ä½ é—®ï¼š

> ç°åœ¨ a æ˜¯å•¥ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š

ğŸ‘‰ **çœ‹æœ€åä¸€è¡Œå…³äº a çš„è®°å½•**

sequence number = è¡Œå·

---

# å…­ã€è¯»çš„æ—¶å€™ï¼Œsequence number æ€ä¹ˆç”¨ï¼Ÿ

## æƒ…å†µ 1ï¼šæ™®é€šè¯»å–ï¼ˆæ²¡æœ‰ snapshotï¼‰

æ•°æ®åº“ä¼šè¯´ï¼š

> **æˆ‘åªå…³å¿ƒâ€œä¸è¶…è¿‡å½“å‰æœ€å¤§åºå·â€çš„æœ€æ–°ä¸€æ¡**

æ¯”å¦‚ç°åœ¨æœ€å¤§æ˜¯ 4ï¼š

```
a@4 â†’ DELETE  âŒ
```

æ‰€ä»¥ï¼š

```
a ä¸å­˜åœ¨
```

---

## æƒ…å†µ 2ï¼šç”¨äº† Snapshotï¼ˆéå¸¸é‡è¦ï¼‰

å‡è®¾ä½ åœ¨ sequence=3 çš„æ—¶å€™æ‹äº†ä¸€ä¸ªå¿«ç…§ï¼š

```
snapshot_seq = 3
```

é‚£ä½ å†è¯»ï¼š

```
åªå…è®¸çœ‹ seq â‰¤ 3 çš„è®°å½•
```

äºæ˜¯ï¼š

```
a@3 â†’ 3  âœ…
```

---

# ä¸ƒã€ä¸ºä»€ä¹ˆ Delete ä¹Ÿè¦ sequence numberï¼Ÿ

ä½ å¯èƒ½ä¼šé—®ï¼š

> Delete ç›´æ¥æŠŠ key åˆ æ‰ä¸è¡Œå—ï¼Ÿ

ä¸è¡Œã€‚

### ä¸¾ä¸ªè¶…çº§å…³é”®çš„ä¾‹å­ï¼š

```
Put(a,1)   seq=1
Flush â†’ SSTable
Delete(a)  seq=2
```

å¦‚æœ delete åªæ˜¯â€œåˆ æ–‡ä»¶â€ï¼š

* compaction æ—¶
* æ—§çš„ a=1 åˆå¯èƒ½è¢«åˆå¹¶å›æ¥ ğŸ˜±

æ‰€ä»¥ LevelDB çš„ delete æ˜¯ï¼š

```
a@2 â†’ DELETE
```

åªè¦ä½ çœ‹åˆ°ï¼š

```
DELETE çš„ seq æ¯” VALUE å¤§
```

å°±çŸ¥é“ï¼š

> **è¿™ä¸ª key å·²ç»è¢«åˆ äº†**

---

# å…«ã€sequence number å’Œ MemTable / SSTable çš„å…³ç³»

### ä¸ç®¡æ•°æ®åœ¨å“ªï¼š

* MemTable
* Immutable MemTable
* SSTableï¼ˆL0 / L1 / ...ï¼‰

**æ ¼å¼å®Œå…¨ä¸€æ ·ï¼š**

```
(user_key, sequence_number, type) â†’ value
```

è¿™æ„å‘³ç€ï¼š

> **æ–°æ•°æ®ä¸ä¸€å®šåœ¨â€œæ›´æ–°çš„æ–‡ä»¶â€é‡Œ**
>
> ä½†ä¸€å®šæœ‰ **æ›´å¤§çš„ sequence number**

---

# ä¹ã€Compaction æ—¶ï¼Œsequence number å¹²å˜›ï¼Ÿ

Compaction ä¼šé—®ä¸€ä¸ªé—®é¢˜ï¼š

> **è¿™äº›æ—§ç‰ˆæœ¬è¿˜æœ‰äººèƒ½çœ‹åˆ°å—ï¼Ÿ**

å¦‚æœæ²¡æœ‰ snapshot éœ€è¦å®ƒï¼š

```
a@1
a@2
a@3
```

åªä¿ç•™ï¼š

```
a@3
```

sequence number æ˜¯åˆ¤æ–­â€œè°å¯ä»¥è¢«æ‰”æ‰â€çš„å”¯ä¸€ä¾æ®ã€‚

---

# åã€å¦‚æœæ²¡æœ‰ sequence number ä¼šæ€æ ·ï¼Ÿï¼ˆåè¯æ³•ï¼‰

æƒ³è±¡æ²¡æœ‰ seqï¼š

```
a åœ¨ sstable1
a åœ¨ sstable2
```

é—®é¢˜æ¥äº†ï¼š

* å“ªä¸ªæ–°ï¼Ÿ
* delete è¦†ç›–è°ï¼Ÿ
* snapshot æ€ä¹ˆå®ç°ï¼Ÿ

ğŸ‘‰ **ç»Ÿç»Ÿåšä¸äº†**

---

# åä¸€ã€ä½ å¯ä»¥è¿™æ ·â€œè„‘è¡¥ LevelDBâ€

> LevelDB æœ¬è´¨æ˜¯ä¸€ä¸ª
> **æŒ‰ key åˆ†ç»„ã€æŒ‰ sequence number æ’åºçš„æ—¥å¿—ç³»ç»Ÿ**

æ¯ä¸ª key éƒ½æœ‰ä¸€æ¡â€œæ—¶é—´çº¿â€ã€‚

---

# åäºŒã€ç»ˆæè®°å¿†æ³•ï¼ˆå¼ºçƒˆå»ºè®®è®°ä½ï¼‰

> **sequence number = æ—¶é—´è½´**

* å¤§çš„åœ¨å
* å°çš„åœ¨å‰
* è¯»çš„æ—¶å€™ï¼Œæ°¸è¿œå–â€œæ—¶é—´è½´ä¸Šä½ èƒ½çœ‹åˆ°çš„æœ€åä¸€æ¡â€

---

# åä¸‰ã€ä¸€å¥è¯æ€»ç»“ï¼ˆé€šä¿—ç‰ˆï¼‰

> **LevelDB ä¸ä¼šæ”¹æ•°æ®ï¼Œåªä¼šâ€œè®°å†å²â€ï¼Œsequence number å°±æ˜¯å†å²çš„é¡ºåºå·**

---

